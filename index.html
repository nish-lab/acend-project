<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project: Ascend</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;500;600;700;900&family=Cormorant+Garamond:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- Shared background --- */
        body {
            margin: 0;
            height: 100vh;
            font-family: 'Inter', sans-serif;
            color: white;
            overflow: hidden;
            background: radial-gradient(circle at center, rgba(20,30,50,1) 0%, rgb(15,30,59) 100%);
            animation: bgPulse 10s ease-in-out infinite alternate;
        }

        @keyframes bgPulse {
            0%   { background: radial-gradient(circle at center, rgba(18,28,48,1) 0%, rgba(10,20,38,1) 100%); }
            100% { background: radial-gradient(circle at center, rgba(32,54,92,1) 0%, rgba(5,10,20,1) 100%); }
        }

        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .font-garamond { font-family: 'Cormorant Garamond', serif; }

        /* --- Page Transitions --- */
        .page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; visibility: hidden; 
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform: translateY(10px);
        }
        .page.active { 
            opacity: 1; 
            visibility: visible; 
            transform: translateY(0);
        }
        .page-content {
             width: 100%; max-width: 42rem;
             height: 100%;
             padding: 1rem;
             display: flex; flex-direction: column;
        }

        /* --- Ornate Theme & Popups --- */
        .notification-wrapper { transition: all 0.4s ease-in-out; }
        .notification-box {
            border: 1px solid #5a8fbb;
            background: linear-gradient(rgba(10, 25, 47, 0.8), rgba(10, 25, 47, 0.95));
            padding: 2.5rem 4rem; position: relative;
            box-shadow: 0 0 20px rgba(90, 143, 187, 0.2);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .corner { position: absolute; width: 25px; height: 25px; border-color: #9fcdff; border-style: solid; }
        .corner.top-left { top: -2px; left: -2px; border-width: 2px 0 0 2px; }
        .corner.top-right { top: -2px; right: -2px; border-width: 2px 2px 0 0; }
        .corner.bottom-left { bottom: -2px; left: -2px; border-width: 0 0 2px 2px; }
        .corner.bottom-right { bottom: -2px; right: -2px; border-width: 0 2px 2px 0; }
        .crest { position: absolute; top: -14px; left: 50%; transform: translateX(-50%); width: 50px; height: 20px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 40'%3E%3Cpath d='M50 0 C40 10, 30 15, 20 20 C30 25, 40 30, 50 40 C60 30, 70 25, 80 20 C70 15, 60 10, 50 0 Z' fill='none' stroke='%239fcdff' stroke-width='2'/%3E%3Cpath d='M50 5 C45 12, 38 16, 30 20 C38 24, 45 28, 50 35 C55 28, 62 24, 70 20 C62 16, 55 12, 50 5 Z' fill='none' stroke='%239fcdff' stroke-width='1'/%3E%3C/svg%3E"); background-size: contain; background-repeat: no-repeat; background-position: center; }
        .text-glow-subtle { color: #cce3ff; text-shadow: 0 0 10px rgba(159, 205, 255, 0.5); }
        .btn-system { background-color: rgba(10, 25, 47, 0.7); border: 1px solid #5a8fbb; transition: all 0.2s ease-in-out; }
        .btn-system:hover { background-color: #5a8fbb; box-shadow: 0 0 15px #5a8fbb; color: white; }
        
        /* --- General UI --- */
        .text-glow-blue { text-shadow: 0 0 8px rgba(59, 130, 246, 0.7); }
        .text-glow-purple { text-shadow: 0 0 8px rgba(168, 85, 247, 0.7); }
        .text-glow-red { text-shadow: 0 0 8px rgba(239, 68, 68, 0.7); }
        .box-bg { background-color: rgba(23, 23, 23, 0.85); border: 1px solid rgba(55, 65, 81, 0.5); backdrop-filter: blur(10px); }
        .progress-bar-bg { background-color: #2D3748; }
        .progress-bar-fill { background: linear-gradient(90deg, #3B82F6, #8B5CF6); transition: width 0.5s ease; }
        .btn-plus { background-color: rgba(59, 130, 246, 0.2); border: 1px solid #3B82F6; }
        .btn-plus:disabled { background-color: #2d3748; border-color: #4a5568; color: #718096; cursor: not-allowed; }
        .nav-item { transition: all 0.2s ease-in-out; cursor: pointer; }
        .nav-item.active, .nav-item:hover { color: #8B5CF6; transform: translateY(-2px); }
        .quest-checkbox { appearance: none; width: 1.5rem; height: 1.5rem; border: 2px solid #4A5568; border-radius: 0.25rem; cursor: pointer; }
        .quest-checkbox:checked { background-color: #3B82F6; border-color: #3B82F6; }
        .quest-checkbox:checked::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: #FFFFFF; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.8rem; }
        .quest-item:has(.quest-checkbox:checked) { text-decoration: line-through; color: #6B7280; }
        .btn-claim { background-color: #b48f00; color: #fffbe6; }
        .btn-claim:hover { background-color: #facc15; color: #422006; box-shadow: 0 0 10px #facc15; }
        .btn-claim:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-purchase { background-color: #1a4a7a; color: #a2cfff; }
        .btn-sell { background-color: #7a1a1a; color: #ffc2c2; }
        .btn-use { background-color: #1a7a4a; color: #a2ffcf; }
        .quest-tab { color: #8aacc8; border-bottom: 2px solid transparent; cursor: pointer; }
        .quest-tab.active, .quest-tab:hover { color: #e0f2ff; border-bottom-color: #9fcdff; }
        .quest-card { background-color: rgba(10, 25, 47, 0.5); border: 1px solid #2a3a5a; }
        .quest-card.completed { border-left: 4px solid #facc15; text-decoration: line-through; color: #6B7280; }
        .form-input { background-color: rgba(0,0,0,0.3); border: 1px solid #2a3a5a; color: white; }
        .class-card { border: 2px solid #2a3a5a; cursor: pointer; }
        .class-card.selected { border-color: #9fcdff; transform: scale(1.05); }

        /* --- Loading Screen Styles --- */
        .icon-container { display: flex; gap: 0px; }
        .guild-icon {
            width: 50px; height: 50px;
            animation: iconGlow 1.5s infinite alternate;
            filter: drop-shadow(0 0 20px #00f0ff);
            margin: 0 10px;
        }
        @keyframes iconGlow {
            from { filter: drop-shadow(0 0 5px #00f0ff) brightness(1); }
            to   { filter: drop-shadow(0 0 24px #00f0ff) brightness(1.35); }
        }
        .fade-stagger { opacity: 0; animation: fadeIn 600ms ease forwards; }
        .fade-1 { animation-delay: 0ms; }
        .fade-2 { animation-delay: 150ms; }
        .fade-3 { animation-delay: 300ms; }
        .fade-4 { animation-delay: 450ms; }
        .fade-5 { animation-delay: 600ms; }
        @keyframes fadeIn { to { opacity: 1; } }

        /* --- Intro Screen Styles --- */
        .daggers {
            position: relative; width: 160px; height: 160px;
            display: grid; place-items: center; margin-bottom: 20px;
            filter: drop-shadow(0 0 18px rgba(0, 240, 255, 0.75));
            animation: daggersPulse 1.8s ease-in-out infinite;
        }
        @keyframes daggersPulse {
            0%   { transform: scale(0.98); filter: drop-shadow(0 0 10px rgba(0, 240, 255, 0.55)); }
            50%  { transform: scale(1.03); filter: drop-shadow(0 0 22px rgba(0, 240, 255, 0.95)); }
            100% { transform: scale(0.98); filter: drop-shadow(0 0 10px rgba(0, 240, 255, 0.55)); }
        }
        .daggers img {
            position: absolute; width: 150%; height: 150%;
            object-fit: contain; opacity: 0.95;
        }
        .daggers img:first-child { transform: rotate(8deg) translate(-6px, -6px) scaleX(-1); }
        .daggers img:last-child { transform: rotate(-8deg) translate(6px, -6px); }
        .btn-intro {
            padding: 12px 22px; border: 1px solid rgba(0, 200, 255, 0.65);
            background: rgba(0, 30, 60, 0.6); color: #cfefff;
            border-radius: 6px; cursor: pointer; backdrop-filter: blur(2px);
            transition: transform 120ms ease, box-shadow 200ms ease, background 200ms ease;
        }
        .btn-intro:hover {
            transform: translateY(-1px); background: rgba(0, 45, 85, 0.75);
            box-shadow: 0 0 18px rgba(0, 210, 255, 0.55);
        }
        
        /* Status Page Styles */
        .status-header {
            border: 1px solid rgba(120,170,210,0.35);
            padding: 0.5rem 1rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            margin-bottom: 1.5rem;
            color: #cfefff;
            text-shadow: 0 0 8px rgba(0, 230, 255, 0.6);
        }
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.25rem;
        }
        .stat-item .stat-name {
             display: flex;
             align-items: center;
        }
        .stat-item i {
            width: 30px;
            text-align: center;
            margin-right: 0.75rem;
            color: #9ddcff;
        }

    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="page-loading" class="page active">
        <div class="icon-container">
            <i class="fas fa-helmet-safety guild-icon fade-stagger fade-1"></i>
            <i class="fas fa-paw guild-icon fade-stagger fade-2"></i>
            <i class="fas fa-shield-halved guild-icon fade-stagger fade-3"></i>
            <i class="fas fa-crown guild-icon fade-stagger fade-4"></i>
            <i class="fas fa-staff-snake guild-icon fade-stagger fade-5"></i>
        </div>
    </div>

    <!-- Intro Screen -->
    <div id="page-intro" class="page">
        <div class="daggers">
            <!-- Embedded Base64 image to ensure it loads without external files -->
            <img src="data:image/webp;base64,UklGRjAEAABXRUJQVlA4ICQEAABwHwCdASoUApQAPm02lkikIqGYBABABsCwlpu3//4x4Q/mf+d/sH8Z/sv2f/V/2H/L/2H/a/2L/hf4z/N/3D/U/gH/Of5b/cf8f/Bf9x/pP8B/0P/B/3X/A/2f/B/3P+4/8X/p/gD/kv9p/3P+D/5P/A/3H/I/7//8/4v///9z3AP8p/oP/B/yH/G/6H/B/7b/if9f/qf+T/s//L/5v/L/4H/Pf6H/p/5r/x/9z/yv+F/3P+3/8v/p/gH+U/0n/Q/3n/L/7X/k/7v/4/4//p//L/5H/Vf8D/g/8r/qf+L/wv+p/4P/O/6H/o/5r/rf+T/u//L/8H/3f+B/9v//+Gf5D/Yf9z/lf9t/3v+F/3v/B/7H/E/7n/q/+b/zP+h/5P+y/8v/u/8H/v/+B/////+A/8H/Yf9z/lf9t/3v+F/3v/B/7H/E/7n/q/+b/zP+h/5P+y/8v/u/8H/v/+B/////+A////gA" alt="dagger"/>
            <img src="data:image/webp;base64,UklGRjAEAABXRUJQVlA4ICQEAABwHwCdASoUApQAPm02lkikIqGYBABABsCwlpu3//4x4Q/mf+d/sH8Z/sv2f/V/2H/L/2H/a/2L/hf4z/N/3D/U/gH/Of5b/cf8f/Bf9x/pP8B/0P/B/3X/A/2f/B/3P+4/8X/p/gD/kv9p/3P+D/5P/A/3H/I/7//8/4v///9z3AP8p/oP/B/yH/G/6H/B/7b/if9f/qf+T/s//L/5v/L/4H/Pf6H/p/5r/x/9z/yv+F/3P+3/8v/p/gH+U/0n/Q/3n/L/7X/k/7v/4/4//p//L/5H/Vf8D/g/8r/qf+L/wv+p/4P/O/6H/o/5r/rf+T/u//L/8H/3f+B/9v//+Gf5D/Yf9z/lf9t/3v+F/3v/B/7H/E/7n/q/+b/zP+h/5P+y/8v/u/8H/v/+B/////+A/8H/Yf9z/lf9t/3v+F/3v/B/7H/E/7n/q/+b/zP+h/5P+y/8v/u/8H/v/+B/////+A////gA" alt="dagger"/>
        </div>
        <h1 class="text-3xl font-orbitron font-bold tracking-wider text-glow-subtle">ASCEND</h1>
        <p class="text-gray-300 mt-2 mb-6">You have been selected as the Player</p>
        <button id="accept-button" class="btn-intro font-bold">ACCEPT</button>
    </div>

    <!-- Universal Notification Popup -->
    <div id="page-universal-popup" class="page p-4">
        <div class="notification-wrapper w-full max-w-lg">
            <div id="popup-box" class="notification-box">
                <div class="corner top-left"></div><div class="corner top-right"></div>
                <div class="corner bottom-left"></div><div class="corner bottom-right"></div>
                <div class="crest"></div>
                <div id="universal-popup-content" class="notification-box-content text-center"></div>
            </div>
        </div>
    </div>

    <!-- Page 0: Login/Signup -->
    <div id="page-login" class="page">
        <div class="notification-box w-full max-w-sm">
            <div class="crest"></div>
            <div id="login-form">
                <h2 class="font-garamond text-2xl text-glow-subtle mb-6 text-center">Player Login</h2>
                <div class="space-y-4">
                    <div><label for="login-email" class="block mb-1 text-sm">Email</label><input type="email" id="login-email" class="form-input w-full p-2 rounded-sm" placeholder="player@email.com"></div>
                    <div><label for="login-password" class="block mb-1 text-sm">Password</label><input type="password" id="login-password" class="form-input w-full p-2 rounded-sm" placeholder="••••••••"></div>
                </div>
                <button id="login-button" class="btn-system w-full font-bold py-2 mt-6 rounded-sm text-lg">Login</button>
                <p class="text-center mt-4 text-sm">Don't have an account? <a href="#" id="show-signup" class="text-glow-subtle hover:underline">Sign Up</a></p>
            </div>
            <div id="signup-form" class="hidden">
                 <h2 class="font-garamond text-2xl text-glow-subtle mb-6 text-center">Create Account</h2>
                <div class="space-y-4">
                    <div><label for="signup-email" class="block mb-1 text-sm">Email</label><input type="email" id="signup-email" class="form-input w-full p-2 rounded-sm" placeholder="player@email.com"></div>
                    <div><label for="signup-password" class="block mb-1 text-sm">Password</label><input type="password" id="signup-password" class="form-input w-full p-2 rounded-sm" placeholder="••••••••"></div>
                </div>
                <button id="signup-button" class="btn-system w-full font-bold py-2 mt-6 rounded-sm text-lg">Sign Up</button>
                <p class="text-center mt-4 text-sm">Already have an account? <a href="#" id="show-login" class="text-glow-subtle hover:underline">Login</a></p>
            </div>
        </div>
    </div>

    <!-- Page 2: Onboarding Questionnaire -->
    <div id="page-onboarding" class="page p-4">
        <div class="notification-box w-full max-w-lg mx-auto h-auto max-h-[90vh] flex flex-col">
             <div class="crest"></div>
             <div class="flex-grow overflow-y-auto pr-2" id="onboarding-content"></div>
             <div class="flex-shrink-0 pt-4">
                <button id="next-button" class="btn-system w-full font-bold py-3 px-10 rounded-sm text-lg">Next</button>
            </div>
        </div>
    </div>

    <!-- Main App Container (Dashboard, Shop, etc.) -->
    <div id="page-app" class="page flex-col justify-between">
        <div class="page-content overflow-y-auto">
             <!-- App screens will be injected here -->
        </div>
        <div class="w-full max-w-lg mx-auto p-2 flex-shrink-0">
             <div class="box-bg rounded-full flex justify-around items-center p-3 text-gray-400">
                <a href="#quests" class="nav-item text-center"><i class="fa-solid fa-shield-halved text-2xl"></i><span class="text-xs block">Quests</span></a>
                <a href="#inventory" class="nav-item text-center"><i class="fa-solid fa-box-archive text-2xl"></i><span class="text-xs block">Inventory</span></a>
                <a href="#profile" class="nav-item active text-center"><i class="fa-solid fa-user text-2xl"></i><span class="text-xs block">Profile</span></a>
                <a href="#journal" class="nav-item text-center"><i class="fa-solid fa-book-open text-2xl"></i><span class="text-xs block">Journal</span></a>
                <a href="#shop" class="nav-item text-center"><i class="fa-solid fa-store text-2xl"></i><span class="text-xs block">Shop</span></a>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE & CONFIG ---
            let state = { 
                currentPage: 'loading',
                currentAppScreen: 'profile',
                currentQuestTab: 'daily', // Set default quest tab
                onboardingStep: 0, 
                player: null
            };
            const pages = { 
                loading: document.getElementById('page-loading'),
                intro: document.getElementById('page-intro'),
                login: document.getElementById('page-login'), 
                popup: document.getElementById('page-universal-popup'), 
                onboarding: document.getElementById('page-onboarding'), 
                app: document.getElementById('page-app') 
            };
            const appScreenContainer = pages.app.querySelector('.page-content');
            const popupBox = document.getElementById('popup-box');
            
            // --- TEMPLATES ---
            const onboardingSteps = [
                { title: 'Create Your Profile', content: `<div><label for="name" class="block mb-1 text-sm">Name</label><input type="text" id="name" class="form-input w-full p-2 rounded-sm" placeholder="Player_01"></div><div class="grid grid-cols-2 gap-4 mt-4"><div><label for="age" class="block mb-1 text-sm">Age</label><input type="number" id="age" class="form-input w-full p-2 rounded-sm" placeholder="25"></div><div><label for="weight" class="block mb-1 text-sm">Weight (kg)</label><input type="number" id="weight" class="form-input w-full p-2 rounded-sm" placeholder="75"></div></div>` },
                { title: 'Choose Your Path', content: `<div class="space-y-3"><div class="class-card p-3 rounded-lg" data-class="Assassin"><h3 class="font-bold text-lg"><i class="fas fa-running mr-2"></i>Assassin</h3><p class="text-sm text-gray-400">Focus on agility and HIIT.</p></div><div class="class-card p-3 rounded-lg" data-class="Tank"><h3 class="font-bold text-lg"><i class="fas fa-shield-alt mr-2"></i>Tank</h3><p class="text-sm text-gray-400">Focus on strength and endurance.</p></div><div class="class-card p-3 rounded-lg" data-class="Mage"><h3 class="font-bold text-lg"><i class="fas fa-brain mr-2"></i>Mage</h3><p class="text-sm text-gray-400">Focus on flexibility and skill.</p></div></div>` },
                { title: 'Assess Your Power', content: `<p class="text-center text-sm text-gray-400 -mt-2 mb-4">Enter your max reps or time in a single set.</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="pushups" class="block mb-1 text-sm">Push-ups</label><input type="number" id="pushups" class="form-input w-full p-2 rounded-sm" placeholder="10"></div>
                        <div><label for="situps" class="block mb-1 text-sm">Sit-ups</label><input type="number" id="situps" class="form-input w-full p-2 rounded-sm" placeholder="20"></div>
                        <div><label for="squats" class="block mb-1 text-sm">Squats</label><input type="number" id="squats" class="form-input w-full p-2 rounded-sm" placeholder="25"></div>
                        <div><label for="run" class="block mb-1 text-sm">Max Run (km)</label><input type="number" id="run" class="form-input w-full p-2 rounded-sm" placeholder="2"></div>
                        <div><label for="burpees" class="block mb-1 text-sm">Burpees</label><input type="number" id="burpees" class="form-input w-full p-2 rounded-sm" placeholder="10"></div>
                        <div><label for="plank" class="block mb-1 text-sm">Plank (seconds)</label><input type="number" id="plank" class="form-input w-full p-2 rounded-sm" placeholder="30"></div>
                    </div>
                    <div class="mt-4"><label for="stretching" class="block mb-1 text-sm">Stretching</label><select id="stretching" class="form-input w-full p-2 rounded-sm"><option value="0">Never</option><option value="1" selected>Sometimes</option><option value="2">Regularly</option></select></div>
                    ` }
            ];
             const shopItems = [
                { id: 'xp_boost', name: 'XP Boost', icon: 'fa-flask-potion', color: 'text-purple-400', desc: 'Doubles XP from your next workout.', price: 500 },
                { id: 'dungeon_key', name: 'Dungeon Key', icon: 'fa-key', color: 'text-yellow-400', desc: 'Unlocks a random special quest.', price: 1000 },
                { id: 'monarch_theme', name: 'Monarch Theme', icon: 'fa-palette', color: 'text-indigo-400', desc: 'Unlock the purple UI theme.', price: 5000 },
                { id: 'gift_box', name: 'Gift Box', icon: 'fa-gift', color: 'text-red-400', desc: 'Contains a mysterious reward.', price: 0 } // Not for sale
            ];
            
            // --- FUNCTIONS ---
            function createNewPlayerState() {
                return { 
                    name: 'Player_01', level: 1, xp: 0, gold: 1000, statPoints: 5,
                    xpForNextLevel: 100,
                    class: 'None', 
                    stats: { str: 10, agi: 10, sta: 10, int: 10, per: 10 },
                    baseline: { pushups: 15, situps: 20, squats: 25, run: 2, burpees: 10, plank: 30, stretching: 1 },
                    streaks: { pushups: 0, situps: 0, squats: 0, run: 0, burpees: 0, plank: 0, stretching: 0 },
                    inventory: {},
                    journalSubmittedToday: false,
                    mainQuestsClaimed: { level5: false },
                    activeDungeonQuest: null
                };
            }

            function switchPage(pageName) {
                state.currentPage = pageName;
                Object.keys(pages).forEach(key => {
                    const page = pages[key];
                    if (key === pageName) {
                        page.classList.add('active');
                    } else {
                        page.classList.remove('active');
                    }
                });
            }
            
            function showModal(content, onConfirm) {
                document.getElementById('universal-popup-content').innerHTML = content;
                switchPage('popup');

                const confirmButton = document.getElementById('popup-confirm');
                if (confirmButton && onConfirm) {
                    confirmButton.onclick = () => {
                        switchPage('app');
                        onConfirm();
                    };
                }

                const closeButton = document.getElementById('popup-close');
                if (closeButton) {
                    closeButton.onclick = () => switchPage('app');
                }
            }

            function showAutoPopup(content, duration = 2000) {
                return new Promise(resolve => {
                    document.getElementById('universal-popup-content').innerHTML = content;
                    switchPage('popup');
                    
                    setTimeout(() => {
                        popupBox.style.opacity = '0';
                        popupBox.style.transform = 'translateY(-20px)';
                        setTimeout(() => {
                            popupBox.style.opacity = '1';
                            popupBox.style.transform = 'translateY(0)';
                            resolve();
                        }, 500);
                    }, duration);
                });
            }

             async function showPopup(content) {
                return new Promise(resolve => {
                    document.getElementById('universal-popup-content').innerHTML = content;
                    switchPage('popup');
                    
                    const okButton = document.getElementById('popup-ok');
                    if (okButton) {
                        okButton.onclick = () => {
                            const prevPage = state.currentPage;
                            popupBox.style.opacity = '0';
                            popupBox.style.transform = 'translateY(-20px)';
                            setTimeout(() => {
                                if(prevPage === 'popup') {
                                    const activePages = Object.keys(pages).filter(p => pages[p].classList.contains('active') && p !== 'popup');
                                    if (activePages.length > 0) {
                                        switchPage(activePages[0]);
                                    } else {
                                        switchPage('login'); // Fallback
                                    }
                                }
                                popupBox.style.opacity = '1';
                                popupBox.style.transform = 'translateY(0)';
                                resolve();
                            }, 500);
                        };
                    }
                });
            }
            
            function renderAppScreen() {
                let content = '';
                if (state.currentAppScreen === 'profile') content = getProfileHTML();
                if (state.currentAppScreen === 'shop') content = getShopHTML();
                if (state.currentAppScreen === 'inventory') content = getInventoryHTML();
                if (state.currentAppScreen === 'quests') content = getQuestsHTML();
                if (state.currentAppScreen === 'journal') content = getJournalHTML();
                appScreenContainer.innerHTML = content;
                
                if (state.currentAppScreen === 'profile') {
                    updateDashboardUI();
                } else if (state.currentAppScreen === 'shop') {
                    updateShopUI();
                } else if (state.currentAppScreen === 'inventory') {
                    updateInventoryUI();
                } else if (state.currentAppScreen === 'quests') {
                    updateQuestsUI();
                } else if (state.currentAppScreen === 'journal') {
                    updateJournalUI();
                }
            }
            
            function getProfileHTML() {
                return `<div class="w-full max-w-lg mx-auto space-y-6">
                    <div class="status-header">STATUS</div>
                    
                    <div class="box-bg p-4 rounded-lg">
                        <div class="flex items-center space-x-4">
                            <div class="text-7xl font-bold font-orbitron text-glow-subtle" id="level-text"></div>
                            <div class="flex-grow">
                                <h2 id="player-name" class="text-xl font-bold text-white"></h2>
                                <p class="text-gray-400">JOB: <span id="player-title" class="text-blue-400 text-glow-blue"></span></p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-semibold">XP</span>
                                <span id="xp-text" class="text-gray-400"></span>
                            </div>
                            <div class="w-full progress-bar-bg rounded-full h-2.5"><div id="xp-bar" class="progress-bar-fill h-2.5 rounded-full"></div></div>
                        </div>
                    </div>

                    <div class="box-bg p-4 rounded-lg">
                        <div class="stat-grid">
                            <div class="stat-item"><div class="stat-name"><i class="fa-solid fa-dumbbell"></i> STR: <span id="stat-str" class="ml-2 font-bold"></span></div><button data-stat="str" class="btn-plus w-7 h-7 rounded-md text-white"><i class="fa-solid fa-plus"></i></button></div>
                            <div class="stat-item"><div class="stat-name"><i class="fa-solid fa-heart-pulse"></i> STA: <span id="stat-sta" class="ml-2 font-bold"></span></div><button data-stat="sta" class="btn-plus w-7 h-7 rounded-md text-white"><i class="fa-solid fa-plus"></i></button></div>
                            <div class="stat-item"><div class="stat-name"><i class="fa-solid fa-person-running"></i> AGI: <span id="stat-agi" class="ml-2 font-bold"></span></div><button data-stat="agi" class="btn-plus w-7 h-7 rounded-md text-white"><i class="fa-solid fa-plus"></i></button></div>
                            <div class="stat-item"><div class="stat-name"><i class="fa-solid fa-brain"></i> INT: <span id="stat-int" class="ml-2 font-bold"></span></div><button data-stat="int" class="btn-plus w-7 h-7 rounded-md text-white"><i class="fa-solid fa-plus"></i></button></div>
                            <div class="stat-item"><div class="stat-name"><i class="fa-solid fa-hand-fist"></i> PER: <span id="stat-per" class="ml-2 font-bold"></span></div><button data-stat="per" class="btn-plus w-7 h-7 rounded-md text-white"><i class="fa-solid fa-plus"></i></button></div>
                        </div>
                        <div id="stat-points-display" class="mt-4 text-center hidden">
                            <p class="text-sm text-gray-400">Available Ability Points</p>
                            <p id="stat-points-value" class="text-3xl font-bold text-yellow-400"></p>
                        </div>
                    </div>
                </div>`;
            }

            function getShopHTML() {
                const itemsHTML = shopItems
                    .filter(item => item.price > 0)
                    .map(item => `
                    <div class="item-card rounded-lg p-3 text-center flex flex-col box-bg">
                        <div class="text-5xl ${item.color} my-3"><i class="fas ${item.icon}"></i></div>
                        <h3 class="font-semibold text-white">${item.name}</h3>
                        <p class="text-xs text-gray-400 flex-grow">${item.desc}</p>
                        <button data-item-id="${item.id}" class="btn-purchase w-full font-bold py-2 mt-3 rounded-md">
                            <i class="fas fa-coins mr-1"></i> ${item.price}
                        </button>
                    </div>`).join('');

                return `<div class="w-full max-w-lg mx-auto space-y-4">
                    <div class="box-bg p-4 rounded-lg text-center"><h1 class="text-2xl font-bold text-glow-purple">SHOP</h1></div>
                    <div class="box-bg p-3 rounded-lg flex justify-between items-center">
                        <span class="font-semibold text-lg">Your Balance:</span>
                        <span id="gold-balance" class="font-bold text-2xl text-yellow-400"></span>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">${itemsHTML}</div>
                </div>`;
            }

            function getInventoryHTML() {
                let itemsHTML = '';
                const playerItems = Object.keys(state.player.inventory);

                if (playerItems.length === 0) {
                    itemsHTML = `<p class="text-center text-gray-400 col-span-full">Your inventory is empty.</p>`;
                } else {
                    itemsHTML = playerItems.map(itemId => {
                        const item = shopItems.find(i => i.id === itemId);
                        const quantity = state.player.inventory[itemId];
                        if (!item) return '';
                        const sellPrice = Math.floor(item.price / 2);

                        let buttons = '';
                        if (item.id === 'dungeon_key') {
                            buttons = `<button data-item-id="${item.id}" class="btn-use w-full font-bold py-2 mt-3 rounded-md">USE</button>`;
                        } else if (item.price > 0) {
                            buttons = `<button data-item-id="${item.id}" class="btn-sell w-full font-bold py-2 mt-3 rounded-md">SELL (<i class="fas fa-coins mr-1"></i> ${sellPrice})</button>`;
                        } else {
                            buttons = `<div class="py-2 mt-3">Cannot be sold</div>`;
                        }

                        return `<div class="item-card rounded-lg p-3 text-center flex flex-col box-bg">
                            <div class="text-5xl ${item.color} my-3"><i class="fas ${item.icon}"></i></div>
                            <h3 class="font-semibold text-white">${item.name}</h3>
                            <p class="text-xs text-gray-400 flex-grow">Quantity: ${quantity}</p>
                            ${buttons}
                        </div>`;
                    }).join('');
                }

                return `<div class="w-full max-w-lg mx-auto space-y-4">
                    <div class="box-bg p-4 rounded-lg text-center"><h1 class="text-2xl font-bold text-glow-purple">INVENTORY</h1></div>
                     <div class="box-bg p-3 rounded-lg flex justify-between items-center">
                        <span class="font-semibold text-lg">Your Balance:</span>
                        <span id="gold-balance-inv" class="font-bold text-2xl text-yellow-400"></span>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">${itemsHTML}</div>
                </div>`;
            }

            function getQuestsHTML() {
                return `<div class="w-full max-w-lg mx-auto space-y-4">
                    <div class="box-bg p-4 rounded-lg text-center"><h1 class="text-2xl font-bold text-glow-purple">QUESTS</h1></div>
                    <div class="box-bg p-2 rounded-lg flex justify-around">
                        <button data-tab="daily" class="quest-tab active flex-1 py-2 font-semibold">Daily</button>
                        <button data-tab="weekly" class="quest-tab flex-1 py-2 font-semibold">Weekly</button>
                        <button data-tab="main" class="quest-tab flex-1 py-2 font-semibold">Main</button>
                        <button data-tab="dungeon" class="quest-tab flex-1 py-2 font-semibold">Dungeon</button>
                    </div>
                    <div id="quest-list-detailed" class="space-y-3"></div>
                </div>`;
            }
            
            function getJournalHTML() {
                if (state.player.journalSubmittedToday) {
                    return `<div class="w-full max-w-lg mx-auto space-y-4">
                        <div class="box-bg p-4 rounded-lg text-center"><h1 class="text-2xl font-bold text-glow-purple">DAILY JOURNAL</h1></div>
                        <div class="box-bg p-6 rounded-lg text-center">
                            <p class="text-lg">You have already submitted your entry for today.</p>
                            <p class="text-gray-400 mt-2">Please come back tomorrow to write again.</p>
                        </div>
                    </div>`;
                }

                return `<div class="w-full max-w-lg mx-auto space-y-4">
                    <div class="box-bg p-4 rounded-lg text-center"><h1 class="text-2xl font-bold text-glow-purple">DAILY JOURNAL</h1></div>
                    <div class="box-bg p-4 rounded-lg">
                        <p class="text-sm text-gray-300 mb-3">Write about your day. Your thoughts, your struggles, your victories. The system rewards reflection.</p>
                        <textarea id="journal-entry" class="form-input w-full h-48 p-2 rounded-sm resize-none" placeholder="Begin writing here..."></textarea>
                        <div class="flex justify-between items-center mt-3">
                            <span id="word-count" class="text-sm text-gray-400">0 words</span>
                            <button id="submit-journal" class="btn-system font-bold py-2 px-6 rounded-md">Submit Entry</button>
                        </div>
                    </div>
                </div>`;
            }

            function updateDashboardUI() {
                const p = state.player;
                document.getElementById('player-name').textContent = p.name;
                document.getElementById('player-title').textContent = `${p.class}`;
                document.getElementById('level-text').textContent = p.level;
                document.getElementById('xp-text').textContent = `${p.xp} / ${p.xpForNextLevel}`;
                document.getElementById('xp-bar').style.width = `${(p.xp / p.xpForNextLevel) * 100}%`;
                
                Object.keys(p.stats).forEach(key => {
                    document.getElementById(`stat-${key}`).textContent = p.stats[key];
                });

                const statPointsDisplay = document.getElementById('stat-points-display');
                document.getElementById('stat-points-value').textContent = p.statPoints;
                statPointsDisplay.classList.toggle('hidden', p.statPoints <= 0);

                document.querySelectorAll('.btn-plus').forEach(btn => {
                    btn.disabled = p.statPoints <= 0;
                    btn.onclick = handleStatIncrease;
                });
            }

            function updateShopUI() {
                appScreenContainer.querySelector('#gold-balance').innerHTML = `<i class="fas fa-coins mr-2"></i>${state.player.gold} G`;
                appScreenContainer.querySelectorAll('.btn-purchase').forEach(btn => btn.onclick = handlePurchase);
            }
            
            function updateInventoryUI() {
                appScreenContainer.querySelector('#gold-balance-inv').innerHTML = `<i class="fas fa-coins mr-2"></i>${state.player.gold} G`;
                appScreenContainer.querySelectorAll('.btn-sell').forEach(btn => btn.onclick = handleSell);
                appScreenContainer.querySelectorAll('.btn-use').forEach(btn => btn.onclick = handleUseItem);
            }
            
            function updateQuestsUI() {
                const questList = appScreenContainer.querySelector('#quest-list-detailed');
                let content = '';
                const isClaimed = state.player.mainQuestsClaimed.level5;

                if (state.currentQuestTab === 'daily') {
                    content = `<div class="box-bg p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                            <h3 class="text-lg font-semibold text-glow-blue">Daily Quests</h3>
                            <div class="text-right">
                                <p class="text-xs text-gray-400">Time until reset</p>
                                <p id="countdown-timer" class="font-orbitron text-red-400 text-glow-red">00:00:00</p>
                            </div>
                        </div>
                        <div id="quest-list" class="space-y-3"></div>
                        <p class="text-yellow-400 text-sm mt-4 text-center"><i class="fas fa-exclamation-triangle mr-2"></i>Failure to complete will result in a penalty.</p>
                        <div id="claim-container" class="mt-4 hidden"><button id="claim-button" class="btn-claim w-full font-bold py-2 rounded-md">Claim Reward</button></div>
                    </div>`;
                    questList.innerHTML = content;
                    generateQuests();
                    startCountdown();
                } else if (state.currentQuestTab === 'weekly') {
                     content = `<div class="quest-card rounded-lg p-4">
                        <h3 class="font-semibold text-lg text-white">Weekly Consistency</h3>
                        <p class="text-sm text-gray-400 mb-3">Complete Daily Quests 5 times this week.</p>
                        <div class="w-full progress-bar-bg rounded-full h-2.5"><div class="bg-blue-500 h-2.5 rounded-full" style="width: 40%"></div></div>
                        <div class="border-t border-gray-600 mt-3 pt-3 flex justify-between items-center">
                            <div class="text-sm"><span class="font-semibold text-yellow-400">Rewards: </span>1 Dungeon Key</div>
                            <button class="btn-claim font-bold py-1 px-4 rounded-md" disabled>Claim</button>
                        </div>
                    </div>`;
                     questList.innerHTML = content;
                } else if (state.currentQuestTab === 'main') {
                     content = `<div class="quest-card ${isClaimed ? 'completed' : ''} rounded-lg p-4">
                        <h3 class="font-semibold text-lg ${isClaimed ? '' : 'text-white'}">The First Step</h3>
                        <p class="text-sm text-gray-400 mb-3">Reach Level 5.</p>
                        <div class="w-full progress-bar-bg rounded-full h-2.5"><div class="bg-blue-500 h-2.5 rounded-full" style="width: ${ (state.player.level / 5) * 100 }% "></div></div>
                        <div class="border-t border-gray-600 mt-3 pt-3 flex justify-between items-center">
                            <div class="text-sm"><span class="font-semibold text-yellow-400">Rewards: </span>500 XP, 250 G</div>
                            <button id="claim-level-5" class="btn-claim font-bold py-1 px-4 rounded-md" ${state.player.level < 5 || isClaimed ? 'disabled' : ''}>${isClaimed ? 'Claimed' : 'Claim'}</button>
                        </div>
                    </div>`;
                     questList.innerHTML = content;
                } else if (state.currentQuestTab === 'dungeon') {
                    if (state.player.activeDungeonQuest) {
                        const quest = state.player.activeDungeonQuest;
                        content = `<div class="quest-card rounded-lg p-4 border-l-4 border-red-500">
                            <h3 class="font-semibold text-lg text-white">${quest.title}</h3>
                            <p class="text-sm text-gray-400 mb-3">${quest.desc}</p>
                            <div class="border-t border-gray-600 mt-3 pt-3 flex justify-between items-center">
                                <div class="text-sm"><span class="font-semibold text-yellow-400">Rewards: </span>${quest.reward.xp} XP, ${quest.reward.gold} G</div>
                                <button id="abandon-dungeon-quest" class="btn-sell font-bold py-1 px-4 rounded-md">Abandon</button>
                            </div>
                        </div>`;
                    } else {
                        content = `<div class="quest-card rounded-lg p-4 text-center">
                            <p>No active dungeon quest.</p>
                            <p class="text-sm text-gray-400 mt-1">Use a Dungeon Key from your inventory to start one.</p>
                        </div>`;
                    }
                     questList.innerHTML = content;
                }
                

                const claimLevel5Btn = document.getElementById('claim-level-5');
                if (claimLevel5Btn) {
                    claimLevel5Btn.onclick = async () => {
                        if (state.player.mainQuestsClaimed.level5) return;
                        state.player.mainQuestsClaimed.level5 = true;
                        await addXp(500);
                        state.player.gold += 250;
                        await showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Rewards Claimed</h2><p class="text-xl">You received 500 XP and 250 Gold.</p>`, 2000);
                        switchPage('app');
                        renderAppScreen();
                    };
                }
                
                const abandonDungeonBtn = document.getElementById('abandon-dungeon-quest');
                if(abandonDungeonBtn) {
                    abandonDungeonBtn.onclick = handleAbandonDungeonQuest;
                }

                appScreenContainer.querySelectorAll('.quest-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === state.currentQuestTab);
                    tab.onclick = (e) => {
                        state.currentQuestTab = e.currentTarget.dataset.tab;
                        updateQuestsUI();
                    };
                });
            }
            
            function updateJournalUI() {
                const textarea = document.getElementById('journal-entry');
                const wordCountEl = document.getElementById('word-count');
                const submitBtn = document.getElementById('submit-journal');

                if (textarea) {
                    textarea.addEventListener('input', () => {
                        const text = textarea.value.trim();
                        const words = text.split(/\s+/).filter(word => word.length > 0);
                        wordCountEl.textContent = `${words.length} words`;
                    });
                }
                if (submitBtn) {
                    submitBtn.onclick = handleJournalSubmit;
                }
            }

            function generateQuests() {
                const questList = document.getElementById('quest-list');
                if (!questList) return;
                
                const p = state.player;
                let dailyQuests = [];
                const allQuests = {
                    pushups: { name: 'Push-ups', unit: 'reps' },
                    situps: { name: 'Sit-ups', unit: 'reps' },
                    squats: { name: 'Squats', unit: 'reps' },
                    burpees: { name: 'Burpees', unit: 'reps' },
                    plank: { name: 'Plank', unit: 'seconds' },
                    stretching: { name: 'Stretching', unit: 'minutes' },
                    run: { name: 'Run', unit: 'km' }
                };

                // Determine quests based on class
                switch (p.class) {
                    case 'Tank':
                        dailyQuests = ['pushups', 'squats', 'situps'];
                        break;
                    case 'Assassin':
                        dailyQuests = ['run', 'burpees', 'pushups'];
                        break;
                    case 'Mage':
                        dailyQuests = ['plank', 'stretching', 'squats'];
                        break;
                    default:
                        dailyQuests = ['pushups', 'situps', 'squats'];
                }

                let questHTML = '';
                dailyQuests.forEach(key => {
                    const questInfo = allQuests[key];
                    let goal = 0;
                    if (key === 'stretching') {
                        goal = 10; // Fixed 10 minute goal for stretching
                    } else {
                        goal = Math.max(10, Math.ceil(p.baseline[key]) || 10);
                        if(key === 'run') goal = Math.max(1, p.baseline[key] || 1);
                    }
                    
                    questHTML += `<div class="flex items-center space-x-3 quest-item">
                        <input type="checkbox" class="quest-checkbox" data-quest-key="${key}">
                        <label class="flex-1">${questInfo.name} [ 0 / ${goal} ${questInfo.unit} ]</label>
                    </div>`;
                });

                questList.innerHTML = questHTML;
                
                questList.querySelectorAll('.quest-checkbox').forEach(cb => cb.addEventListener('change', checkQuestsCompletion));
                document.getElementById('claim-container').classList.add('hidden');
                document.getElementById('claim-button').disabled = true;
                document.getElementById('claim-button').onclick = handleClaim;
            }
            
            function checkQuestsCompletion() {
                const allChecked = [...document.querySelectorAll('#quest-list .quest-checkbox')].every(cb => cb.checked);
                if (allChecked) {
                    document.getElementById('claim-container').classList.remove('hidden');
                    document.getElementById('claim-button').disabled = false;
                }
            }

            async function addXp(amount) {
                state.player.xp += amount;
                let leveledUp = false;
                while (state.player.xp >= state.player.xpForNextLevel) {
                    leveledUp = true;
                    state.player.level++;
                    state.player.xp -= state.player.xpForNextLevel;
                    state.player.xpForNextLevel = Math.floor(state.player.xpForNextLevel * 1.2);
                    state.player.statPoints += 5;
                }
                if (leveledUp) {
                    const levelUpPopupContent = `<h2 class="font-garamond text-2xl text-glow-subtle mb-4">LEVEL UP!</h2><p class="text-xl mb-6">You have reached Level ${state.player.level}.</p><p>You have gained 5 Stat Points.</p><button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg mt-6">OK</button>`;
                    await showPopup(levelUpPopupContent);
                }
                if (state.currentAppScreen === 'profile') {
                    updateDashboardUI();
                }
            }

            function startCountdown() {
                const timerEl = document.getElementById('countdown-timer');
                if (!timerEl) return;

                const countdownInterval = setInterval(() => {
                    const now = new Date();
                    const tomorrow = new Date();
                    tomorrow.setDate(now.getDate() + 1);
                    tomorrow.setHours(0, 0, 0, 0);

                    const timeRemaining = tomorrow - now;

                    if (timeRemaining <= 1000) {
                        state.player.journalSubmittedToday = false;
                        // Reset streaks for uncompleted quests
                        document.querySelectorAll('#quest-list .quest-checkbox:not(:checked)').forEach(cb => {
                            const key = cb.dataset.questKey;
                            state.player.streaks[key] = 0;
                        });
                        generateQuests();
                    }

                    const hours = Math.floor((timeRemaining / (1000 * 60 * 60)) % 24).toString().padStart(2, '0');
                    const minutes = Math.floor((timeRemaining / 1000 / 60) % 60).toString().padStart(2, '0');
                    const seconds = Math.floor((timeRemaining / 1000) % 60).toString().padStart(2, '0');
                    
                    timerEl.textContent = `${hours}:${minutes}:${seconds}`;
                }, 1000);
            }

            // --- EVENT HANDLERS ---
            async function handleClaim() {
                let baselineIncreased = false;
                let baselineUpdateText = '';

                document.querySelectorAll('#quest-list .quest-checkbox').forEach(cb => {
                    const key = cb.dataset.questKey;
                    if (cb.checked) {
                        state.player.streaks[key]++;
                        if (state.player.streaks[key] >= 3) {
                            baselineIncreased = true;
                            if (key === 'run') {
                                state.player.baseline[key] += 0.1; // Smaller increase for running
                                state.player.baseline[key] = Math.round(state.player.baseline[key] * 10) / 10;
                            } else {
                                state.player.baseline[key]++;
                            }
                            baselineUpdateText += `<p>Your ${key} baseline has increased!</p>`;
                            state.player.streaks[key] = 0; // Reset streak
                        }
                    } else {
                        // Reset streak if quest was not completed
                        state.player.streaks[key] = 0;
                    }
                });

                state.player.gold += 100;
                await showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Rewards Claimed</h2><p class="text-xl">You received 150 XP and 100 Gold.</p>`, 2000);
                await addXp(150);
                
                if (baselineIncreased) {
                    await showPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Baseline Increased!</h2>${baselineUpdateText}<button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg mt-6">OK</button>`);
                }
                
                switchPage('app');
                updateQuestsUI(); // Re-render quests to show new day
            }
            
            async function handleJournalSubmit() {
                const textarea = document.getElementById('journal-entry');
                const text = textarea.value.trim();
                const words = text.split(/\s+/).filter(word => word.length > 0);
                const wordCount = words.length;

                if (wordCount === 0) {
                    await showPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Empty Entry</h2><p class="text-xl mb-6">Please write something before submitting.</p><button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg mt-6">OK</button>`);
                    switchPage('app');
                    return;
                }

                const xpGained = wordCount;
                const goldGained = Math.round(wordCount * 0.5);
                const gotGiftBox = Math.random() < 0.25;

                await addXp(xpGained);
                state.player.gold += goldGained;
                state.player.journalSubmittedToday = true;

                let rewardText = `<p class="text-xl">You received ${xpGained} XP and ${goldGained} Gold.</p>`;
                if (gotGiftBox) {
                    state.player.inventory['gift_box'] = (state.player.inventory['gift_box'] || 0) + 1;
                    rewardText += `<p class="text-xl mt-2 text-red-400">You also found a Gift Box!</p>`;
                }
                
                await showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Journal Submitted</h2>${rewardText}`, 3000);
                switchPage('app');
                renderAppScreen();
            }

            function handleStatIncrease(e) {
                const stat = e.currentTarget.dataset.stat;
                if (state.player.statPoints > 0) {
                    state.player.statPoints--;
                    state.player.stats[stat]++;
                    updateDashboardUI();
                }
            }
            
            async function initializeApp() {
                state.player = createNewPlayerState();
                await showPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4"><i class="fas fa-exclamation-circle mr-2"></i>Alert</h2><p class="text-xl mb-8 font-semibold text-white">[ Welcome, player. ]</p><button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg">OK</button>`);
                switchPage('onboarding');
                renderOnboardingStep();
            }

            function renderOnboardingStep() {
                const step = onboardingSteps[state.onboardingStep];
                document.getElementById('onboarding-content').innerHTML = `<h2 class="font-garamond text-2xl text-glow-subtle mb-4 text-center">${step.title}</h2>${step.content}`;
                if (state.onboardingStep === 1) {
                    document.querySelectorAll('.class-card').forEach(card => card.addEventListener('click', handleClassSelection));
                }
                document.getElementById('next-button').textContent = state.onboardingStep === onboardingSteps.length - 1 ? 'Begin' : 'Next';
            }

            function validateOnboardingStep() {
                const step = state.onboardingStep;
                if (step === 0) {
                    const name = document.getElementById('name').value.trim();
                    const age = document.getElementById('age').value.trim();
                    const weight = document.getElementById('weight').value.trim();
                    if (!name || !age || !weight) return false;
                } else if (step === 1) {
                    if (state.player.class === 'None') return false;
                } else if (step === 2) {
                    const pushups = document.getElementById('pushups').value.trim();
                    const situps = document.getElementById('situps').value.trim();
                    const squats = document.getElementById('squats').value.trim();
                    const run = document.getElementById('run').value.trim();
                    if (!pushups || !situps || !squats || !run) return false;
                }
                return true;
            }

            async function handleLoginAttempt() {
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value.trim();
                if (!email || !password) {
                    const errorPopupContent = `<h2 class="font-garamond text-2xl text-glow-subtle mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Incomplete</h2><p class="text-xl mb-6">Please enter both email and password.</p><button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg mt-6">OK</button>`;
                    await showPopup(errorPopupContent);
                    switchPage('login');
                } else {
                    initializeApp();
                }
            }

            async function handleSignupAttempt() {
                const email = document.getElementById('signup-email').value.trim();
                const password = document.getElementById('signup-password').value.trim();
                if (!email || !password) {
                    const errorPopupContent = `<h2 class="font-garamond text-2xl text-glow-subtle mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Incomplete</h2><p class="text-xl mb-6">Please enter both email and password.</p><button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg mt-6">OK</button>`;
                    await showPopup(errorPopupContent);
                    switchPage('login');
                    document.getElementById('login-form').classList.add('hidden');
                    document.getElementById('signup-form').classList.remove('hidden');
                } else {
                    initializeApp();
                }
            }
            
            async function handleUseItem(e) {
                const itemId = e.currentTarget.dataset.itemId;
                if (itemId === 'dungeon_key') {
                    if (state.player.activeDungeonQuest) {
                        await showPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Dungeon Active</h2><p class="text-xl mb-6">You already have an active dungeon quest.</p><button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg mt-6">OK</button>`);
                        switchPage('app');
                        return;
                    }

                    state.player.inventory.dungeon_key--;
                    if (state.player.inventory.dungeon_key <= 0) {
                        delete state.player.inventory.dungeon_key;
                    }

                    state.player.activeDungeonQuest = generateDungeonQuest();
                    
                    await showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Dungeon Quest Started!</h2><p class="text-xl">Check the Quests tab for your new challenge.</p>`, 2500);
                    switchPage('app');
                    renderAppScreen();
                }
            }
            
            async function handleAbandonDungeonQuest() {
                 const onConfirm = () => {
                    state.player.activeDungeonQuest = null;
                    showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Quest Abandoned</h2>`, 1500).then(() => {
                        switchPage('app');
                        renderAppScreen();
                    });
                };
                showModal(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Abandon Quest?</h2><p class="text-xl mb-6">Are you sure you want to abandon this quest? You will not be refunded the key.</p><div class="flex justify-center space-x-4"><button id="popup-close" class="btn-system font-bold py-2 px-8 rounded-sm">Cancel</button><button id="popup-confirm" class="btn-sell font-bold py-2 px-8 rounded-sm">Confirm</button></div>`, onConfirm);
            }

            function generateDungeonQuest() {
                const p = state.player;
                const exercises = ['pushups', 'situps', 'squats', 'run'];
                const chosenExercise = exercises[Math.floor(Math.random() * exercises.length)];
                
                const multiplier = 1.5 + (p.level * 0.1);
                const baseValue = p.baseline[chosenExercise] || 1;
                
                let goal, title, desc, reward;

                if (chosenExercise === 'run') {
                    goal = Math.round((baseValue * multiplier) * 10) / 10; // Round to 1 decimal place
                    title = "The Endless Road";
                    desc = `Endure and run ${goal}km in a single session.`;
                    reward = { xp: Math.round(goal * 500), gold: Math.round(goal * 250) };
                } else {
                    goal = Math.ceil((baseValue * multiplier) / 5) * 5; // Round up to nearest 5
                    const exerciseName = chosenExercise.charAt(0).toUpperCase() + chosenExercise.slice(1);
                    title = `Test of ${exerciseName}`;
                    desc = `Prove your might. Complete ${goal} ${exerciseName}.`;
                    reward = { xp: Math.round(goal * 15), gold: Math.round(goal * 8) };
                }

                return { id: `dq_${Date.now()}`, title, desc, reward };
            }

            document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-form').classList.add('hidden'); document.getElementById('signup-form').classList.remove('hidden'); });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('signup-form').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden'); });

            document.getElementById('login-button').addEventListener('click', handleLoginAttempt);
            document.getElementById('signup-button').addEventListener('click', handleSignupAttempt);
            
            document.getElementById('next-button').addEventListener('click', async () => {
                if (!validateOnboardingStep()) {
                    const errorPopupContent = `<h2 class="font-garamond text-2xl text-glow-subtle mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Incomplete</h2><p class="text-xl mb-6">Please complete all fields to proceed.</p><button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg mt-6">OK</button>`;
                    await showPopup(errorPopupContent);
                    switchPage('onboarding'); 
                    return;
                }

                if (state.onboardingStep === 0) {
                    state.player.name = document.getElementById('name').value.trim();
                }

                if (state.onboardingStep === 2) {
                    state.player.baseline.pushups = parseInt(document.getElementById('pushups').value) || 0;
                    state.player.baseline.situps = parseInt(document.getElementById('situps').value) || 0;
                    state.player.baseline.squats = parseInt(document.getElementById('squats').value) || 0;
                    state.player.baseline.run = parseFloat(document.getElementById('run').value) || 0;
                    state.player.baseline.burpees = parseInt(document.getElementById('burpees').value) || 0;
                    state.player.baseline.plank = parseInt(document.getElementById('plank').value) || 0;
                    state.player.baseline.stretching = parseInt(document.getElementById('stretching').value) || 0;

                    await showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4"><i class="fas fa-scroll mr-2"></i>Notice</h2><p class="text-xl mb-8 font-semibold text-white">[ A Daily Quest has arrived. ]</p>`, 2500);
                    switchPage('app');
                    renderAppScreen();
                } else {
                    state.onboardingStep++;
                    renderOnboardingStep();
                }
            });

            function handleClassSelection(e) {
                document.querySelectorAll('.class-card').forEach(c => c.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                state.player.class = e.currentTarget.dataset.class;
            }

            function handlePurchase(e) {
                const itemId = e.currentTarget.dataset.itemId;
                const item = shopItems.find(i => i.id === itemId);
                if (!item) return;

                const onConfirm = () => {
                    if (state.player.gold >= item.price) {
                        state.player.gold -= item.price;
                        state.player.inventory[item.id] = (state.player.inventory[item.id] || 0) + 1;
                        showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Purchase Successful</h2><p class="text-xl">You bought ${item.name}.</p>`, 2000).then(() => switchPage('app'));
                        updateShopUI();
                    } else {
                        showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Insufficient Funds</h2><p class="text-xl">You don't have enough Gold.</p>`, 2000).then(() => switchPage('app'));
                    }
                };
                
                showModal(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Confirm Purchase</h2><p class="text-xl mb-6">Buy ${item.name} for ${item.price} G?</p><div class="flex justify-center space-x-4"><button id="popup-close" class="btn-system font-bold py-2 px-8 rounded-sm">Cancel</button><button id="popup-confirm" class="btn-purchase font-bold py-2 px-8 rounded-sm">Confirm</button></div>`, onConfirm);
            }

            function handleSell(e) {
                const itemId = e.currentTarget.dataset.itemId;
                const item = shopItems.find(i => i.id === itemId);
                if (!item) return;
                const sellPrice = Math.floor(item.price / 2);

                const onConfirm = () => {
                    if (state.player.inventory[item.id] > 0) {
                        state.player.inventory[item.id]--;
                        if (state.player.inventory[item.id] === 0) {
                            delete state.player.inventory[item.id];
                        }
                        state.player.gold += sellPrice;
                        showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Item Sold</h2><p class="text-xl">You sold ${item.name} for ${sellPrice} G.</p>`, 2000).then(() => {
                            switchPage('app');
                            renderAppScreen();
                        });
                    }
                };

                showModal(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Confirm Sale</h2><p class="text-xl mb-6">Sell ${item.name} for ${sellPrice} G?</p><div class="flex justify-center space-x-4"><button id="popup-close" class="btn-system font-bold py-2 px-8 rounded-sm">Cancel</button><button id="popup-confirm" class="btn-sell font-bold py-2 px-8 rounded-sm">Confirm</button></div>`, onConfirm);
            }
            
            pages.app.querySelectorAll('.nav-item').forEach(nav => {
                nav.addEventListener('click', (e) => {
                    e.preventDefault();
                    pages.app.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    state.currentAppScreen = e.currentTarget.hash.substring(1);
                    renderAppScreen();
                });
            });

            // --- Initial Loading Logic ---
            setTimeout(() => {
                switchPage('intro');
            }, 3000);

            document.getElementById('accept-button').addEventListener('click', () => {
                switchPage('login');
            });
        });
    </script>
</body>
</html>
