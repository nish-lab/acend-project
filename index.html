<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project: Ascend</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;500;600;700;900&family=Cormorant+Garamond:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- Shared background --- */
        body {
            margin: 0;
            height: 100vh;
            font-family: 'Inter', sans-serif;
            color: white;
            overflow: hidden;
            background: radial-gradient(circle at center, rgba(20,30,50,1) 0%, rgb(15,30,59) 100%);
            animation: bgPulse 10s ease-in-out infinite alternate;
        }

        @keyframes bgPulse {
            0%   { background: radial-gradient(circle at center, rgba(18,28,48,1) 0%, rgba(10,20,38,1) 100%); }
            100% { background: radial-gradient(circle at center, rgba(32,54,92,1) 0%, rgba(5,10,20,1) 100%); }
        }

        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .font-garamond { font-family: 'Cormorant Garamond', serif; }

        /* --- Page Transitions --- */
        .page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; visibility: hidden; 
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform: translateY(10px);
        }
        .page.active { 
            opacity: 1; 
            visibility: visible; 
            transform: translateY(0);
        }
        .page-content, #quest-list-detailed {
             transition: opacity 0.3s ease-in-out;
        }
        .page-content {
             width: 100%; max-width: 42rem;
             height: 100%;
             padding: 1rem;
             display: flex; flex-direction: column;
        }
        .fade-out {
            opacity: 0 !important;
        }

        /* --- Ornate Theme & Popups --- */
        .notification-wrapper { transition: all 0.4s ease-in-out; }
        .notification-box {
            border: 1px solid #5a8fbb;
            background: linear-gradient(rgba(10, 25, 47, 0.8), rgba(10, 25, 47, 0.95));
            padding: 2.5rem 4rem; position: relative;
            box-shadow: 0 0 20px rgba(90, 143, 187, 0.2);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .corner { position: absolute; width: 25px; height: 25px; border-color: #9fcdff; border-style: solid; }
        .corner.top-left { top: -2px; left: -2px; border-width: 2px 0 0 2px; }
        .corner.top-right { top: -2px; right: -2px; border-width: 2px 2px 0 0; }
        .corner.bottom-left { bottom: -2px; left: -2px; border-width: 0 0 2px 2px; }
        .corner.bottom-right { bottom: -2px; right: -2px; border-width: 0 2px 2px 0; }
        .crest { position: absolute; top: -14px; left: 50%; transform: translateX(-50%); width: 50px; height: 20px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 40'%3E%3Cpath d='M50 0 C40 10, 30 15, 20 20 C30 25, 40 30, 50 40 C60 30, 70 25, 80 20 C70 15, 60 10, 50 0 Z' fill='none' stroke='%239fcdff' stroke-width='2'/%3E%3Cpath d='M50 5 C45 12, 38 16, 30 20 C38 24, 45 28, 50 35 C55 28, 62 24, 70 20 C62 16, 55 12, 50 5 Z' fill='none' stroke='%239fcdff' stroke-width='1'/%3E%3C/svg%3E"); background-size: contain; background-repeat: no-repeat; background-position: center; }
        .text-glow-subtle { color: #cce3ff; text-shadow: 0 0 10px rgba(159, 205, 255, 0.5); }
        .btn-system { background-color: rgba(10, 25, 47, 0.7); border: 1px solid #5a8fbb; transition: all 0.2s ease-in-out; }
        .btn-system:hover { background-color: #5a8fbb; box-shadow: 0 0 15px #5a8fbb; color: white; }
        
        /* --- General UI --- */
        .text-glow-blue { text-shadow: 0 0 8px rgba(59, 130, 246, 0.7); }
        .text-glow-purple { text-shadow: 0 0 8px rgba(168, 85, 247, 0.7); }
        .text-glow-red { text-shadow: 0 0 8px rgba(239, 68, 68, 0.7); }
        .box-bg { background-color: rgba(23, 23, 23, 0.85); border: 1px solid rgba(55, 65, 81, 0.5); backdrop-filter: blur(10px); }
        .progress-bar-bg { background-color: #2D3748; }
        .progress-bar-fill { background: linear-gradient(90deg, #3B82F6, #8B5CF6); transition: width 0.5s ease; }
        
        .btn-plus { 
            background-color: rgba(59, 130, 246, 0.2); 
            border: 1px solid #3B82F6; 
            transition: transform 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        .btn-plus:disabled { background-color: #2d3748; border-color: #4a5568; color: #718096; cursor: not-allowed; }
        .btn-plus.pulsate { animation: pulsate-glow 2s infinite ease-in-out; }
        .btn-plus.clicked { animation: click-flash 0.3s ease; }
        @keyframes pulsate-glow {
            0%, 100% { box-shadow: 0 0 4px #3B82F6; }
            50% { box-shadow: 0 0 12px #3B82F6; }
        }
        @keyframes click-flash {
            0% { transform: scale(1); box-shadow: 0 0 15px #8B5CF6; }
            50% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        
        .nav-item { transition: all 0.2s ease-in-out; cursor: pointer; }
        .nav-item.active, .nav-item:hover { color: #8B5CF6; transform: translateY(-2px); }
        .quest-checkbox { appearance: none; width: 1.5rem; height: 1.5rem; border: 2px solid #4A5568; border-radius: 0.25rem; cursor: pointer; }
        .quest-checkbox:checked { background-color: #3B82F6; border-color: #3B82F6; }
        .quest-item:has(.quest-checkbox:checked) { text-decoration: line-through; color: #6B7280; }
        .btn-claim { background-color: #b48f00; color: #fffbe6; }
        .btn-claim:hover { background-color: #facc15; color: #422006; box-shadow: 0 0 10px #facc15; }
        .btn-claim:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-purchase { background-color: #1a4a7a; color: #a2cfff; }
        .btn-sell { background-color: #7a1a1a; color: #ffc2c2; }
        .btn-use { background-color: #1a7a4a; color: #a2ffcf; }
        .quest-tab { color: #8aacc8; border-bottom: 2px solid transparent; cursor: pointer; }
        .quest-tab.active, .quest-tab:hover { color: #e0f2ff; border-bottom-color: #9fcdff; }
        .quest-card { background-color: rgba(10, 25, 47, 0.5); border: 1px solid #2a3a5a; }
        .quest-card.completed { border-left: 4px solid #facc15; text-decoration: line-through; color: #6B7280; }
        .form-input { background-color: rgba(0,0,0,0.3); border: 1px solid #2a3a5a; color: white; }
        .class-card { border: 2px solid #2a3a5a; cursor: pointer; }
        .class-card.selected { border-color: #9fcdff; transform: scale(1.05); }
        .info-icon { cursor: pointer; color: #9ddcff; margin-left: 8px; }

        /* --- Loading Screen Styles --- */
        .icon-container { display: flex; gap: 0px; }
        .guild-icon {
            width: 50px; height: 50px;
            animation: iconGlow 1.5s infinite alternate;
            filter: drop-shadow(0 0 20px #00f0ff);
            margin: 0 10px;
        }
        @keyframes iconGlow {
            from { filter: drop-shadow(0 0 5px #00f0ff) brightness(1); }
            to   { filter: drop-shadow(0 0 24px #00f0ff) brightness(1.35); }
        }
        .fade-stagger { opacity: 0; animation: fadeIn 600ms ease forwards; }
        .fade-1 { animation-delay: 0ms; }
        .fade-2 { animation-delay: 150ms; }
        .fade-3 { animation-delay: 300ms; }
        .fade-4 { animation-delay: 450ms; }
        .fade-5 { animation-delay: 600ms; }
        @keyframes fadeIn { to { opacity: 1; } }

        /* --- Intro Screen Styles --- */
        .daggers {
            position: relative; width: 160px; height: 160px;
            display: grid; place-items: center; margin-bottom: 20px;
            filter: drop-shadow(0 0 18px rgba(0, 240, 255, 0.75));
            animation: daggersPulse 1.8s ease-in-out infinite;
        }
        @keyframes daggersPulse {
            0%   { transform: scale(0.98); filter: drop-shadow(0 0 10px rgba(0, 240, 255, 0.55)); }
            50%  { transform: scale(1.03); filter: drop-shadow(0 0 22px rgba(0, 240, 255, 0.95)); }
            100% { transform: scale(0.98); filter: drop-shadow(0 0 10px rgba(0, 240, 255, 0.55)); }
        }
        .daggers img {
            position: absolute; width: 150%; height: 150%;
            object-fit: contain; opacity: 0.95;
        }
        .daggers img:first-child { transform: rotate(8deg) translate(-6px, -6px) scaleX(-1); }
        .daggers img:last-child { transform: rotate(-8deg) translate(6px, -6px); }
        .btn-intro {
            padding: 12px 22px; border: 1px solid rgba(0, 200, 255, 0.65);
            background: rgba(0, 30, 60, 0.6); color: #cfefff;
            border-radius: 6px; cursor: pointer; backdrop-filter: blur(2px);
            transition: transform 120ms ease, box-shadow 200ms ease, background 200ms ease;
        }
        .btn-intro:hover {
            transform: translateY(-1px); background: rgba(0, 45, 85, 0.75);
            box-shadow: 0 0 18px rgba(0, 210, 255, 0.55);
        }
        
        /* Status Page Styles */
        .status-header {
            border: 1px solid rgba(120,170,210,0.35);
            padding: 0.5rem 1rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            margin-bottom: 1.5rem;
            color: #cfefff;
            text-shadow: 0 0 8px rgba(0, 230, 255, 0.6);
        }
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.25rem;
        }
        .stat-item .stat-name {
             display: flex;
             align-items: center;
        }
        .stat-item i {
            width: 30px;
            text-align: center;
            margin-right: 0.75rem;
            color: #9ddcff;
        }

        /* --- Tutorial Styles --- */
        #tutorial-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }
        #tutorial-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        #tutorial-box {
            position: absolute;
            background-color: rgba(10, 25, 47, 0.95);
            border: 1px solid #5a8fbb;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 0 25px rgba(90, 143, 187, 0.3);
            max-width: 350px;
            z-index: 1002;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #tutorial-overlay.active #tutorial-box {
            opacity: 1;
            transform: translateY(0);
        }
        .tutorial-highlight {
            position: relative;
            z-index: 1001;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.6), 0 0 15px 5px #9fcdff;
            transition: box-shadow 0.5s ease;
        }
        
        /* --- Collection & Gift Box Styles --- */
        .collection-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .collectible-card { background-color: rgba(10, 25, 47, 0.7); border: 1px solid #2a3a5a; aspect-ratio: 1/1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; }
        .collectible-card.unlocked { border-left-width: 4px; }
        .collectible-card.common { border-left-color: #9ca3af; }
        .collectible-card.rare { border-left-color: #3b82f6; }
        .collectible-card.legendary { border-left-color: #facc15; }
        .reward-card-container { display: flex; gap: 1rem; justify-content: center; }
        .reward-card { border: 2px solid #5a8fbb; border-radius: 0.5rem; padding: 1.5rem 1rem; text-align: center; cursor: pointer; transition: all 0.2s ease; perspective: 1000px; width: 100px; height: 140px; }
        .reward-card:hover { transform: translateY(-5px) scale(1.05); border-color: #9fcdff; }
        .reward-card.flipped .reward-card-inner { transform: rotateY(180deg); }
        .reward-card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .reward-card-front, .reward-card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display:flex; flex-direction:column; justify-content:center; align-items:center; border-radius: 0.5rem; background: linear-gradient(rgba(10, 25, 47, 0.9), rgba(20, 40, 70, 0.9)); }
        .reward-card-back { transform: rotateY(180deg); }

        /* --- Monarch Theme --- */
        .theme-monarch .text-glow-blue { text-shadow: 0 0 8px rgba(168, 85, 247, 0.7); }
        .theme-monarch #player-title { color: #c084fc; }
        .theme-monarch .progress-bar-fill { background: linear-gradient(90deg, #a855f7, #d946ef); }
        .theme-monarch .btn-plus { background-color: rgba(168, 85, 247, 0.2); border-color: #a855f7; }
        .theme-monarch .btn-plus.pulsate { animation: pulsate-glow-purple 2s infinite ease-in-out; }
        .theme-monarch .quest-checkbox:checked { background-color: #a855f7; border-color: #a855f7; }
        .theme-monarch .quest-tab.active, .theme-monarch .quest-tab:hover { border-bottom-color: #c084fc; }

        @keyframes pulsate-glow-purple {
            0%, 100% { box-shadow: 0 0 4px #a855f7; }
            50% { box-shadow: 0 0 12px #a855f7; }
        }
    </style>
</head>
<body id="app-body">

    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay">
        <div id="tutorial-box">
            <p id="tutorial-text" class="mb-4"></p>
            <button id="tutorial-next" class="btn-system w-full font-bold py-2 rounded-sm">Next</button>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="page-loading" class="page active">
        <div class="icon-container">
            <i class="fas fa-helmet-safety guild-icon fade-stagger fade-1"></i>
            <i class="fas fa-paw guild-icon fade-stagger fade-2"></i>
            <i class="fas fa-shield-halved guild-icon fade-stagger fade-3"></i>
            <i class="fas fa-crown guild-icon fade-stagger fade-4"></i>
            <i class="fas fa-staff-snake guild-icon fade-stagger fade-5"></i>
        </div>
    </div>

    <!-- Intro Screen -->
    <div id="page-intro" class="page">
        <div class="daggers">
            <!-- Embedded Base64 image to ensure it loads without external files -->
            <img src="assets/images/dagger.webp" alt="dagger"/>
            <img src="assets/images/dagger.webp" alt="dagger"/>
        </div>
        <h1 class="text-3xl font-orbitron font-bold tracking-wider text-glow-subtle">ASCEND</h1>
        <p class="text-gray-300 mt-2 mb-6">You have been selected as the Player</p>
        <button id="accept-button" class="btn-intro font-bold">ACCEPT</button>
    </div>

    <!-- Universal Notification Popup -->
    <div id="page-universal-popup" class="page p-4">
        <div class="notification-wrapper w-full max-w-lg">
            <div id="popup-box" class="notification-box">
                <div class="corner top-left"></div><div class="corner top-right"></div>
                <div class="corner bottom-left"></div><div class="corner bottom-right"></div>
                <div class="crest"></div>
                <div id="universal-popup-content" class="notification-box-content text-center"></div>
            </div>
        </div>
    </div>

    <!-- Page 0: Login/Signup -->
    <div id="page-login" class="page">
        <div class="notification-box w-full max-w-sm">
            <div class="crest"></div>
            <div id="login-form">
                <h2 class="font-garamond text-2xl text-glow-subtle mb-6 text-center">Player Login</h2>
                <div class="space-y-4">
                    <div><label for="login-email" class="block mb-1 text-sm">Email</label><input type="email" id="login-email" class="form-input w-full p-2 rounded-sm" placeholder="player@email.com"></div>
                    <div><label for="login-password" class="block mb-1 text-sm">Password</label><input type="password" id="login-password" class="form-input w-full p-2 rounded-sm" placeholder="••••••••"></div>
                </div>
                <button id="login-button" class="btn-system w-full font-bold py-2 mt-6 rounded-sm text-lg">Login</button>
                <p class="text-center mt-4 text-sm">Don't have an account? <a href="#" id="show-signup" class="text-glow-subtle hover:underline">Sign Up</a></p>
            </div>
            <div id="signup-form" class="hidden">
                 <h2 class="font-garamond text-2xl text-glow-subtle mb-6 text-center">Create Account</h2>
                <div class="space-y-4">
                    <div><label for="signup-email" class="block mb-1 text-sm">Email</label><input type="email" id="signup-email" class="form-input w-full p-2 rounded-sm" placeholder="player@email.com"></div>
                    <div><label for="signup-password" class="block mb-1 text-sm">Password</label><input type="password" id="signup-password" class="form-input w-full p-2 rounded-sm" placeholder="••••••••"></div>
                </div>
                <button id="signup-button" class="btn-system w-full font-bold py-2 mt-6 rounded-sm text-lg">Sign Up</button>
                <p class="text-center mt-4 text-sm">Already have an account? <a href="#" id="show-login" class="text-glow-subtle hover:underline">Login</a></p>
            </div>
        </div>
    </div>

    <!-- Page 2: Onboarding Questionnaire -->
    <div id="page-onboarding" class="page p-4">
        <div class="notification-box w-full max-w-lg mx-auto h-auto max-h-[90vh] flex flex-col">
             <div class="crest"></div>
             <div class="flex-grow overflow-y-auto pr-2" id="onboarding-content"></div>
             <div class="flex-shrink-0 pt-4">
                <button id="next-button" class="btn-system w-full font-bold py-3 px-10 rounded-sm text-lg">Next</button>
            </div>
        </div>
    </div>

    <!-- Main App Container (Dashboard, Shop, etc.) -->
    <div id="page-app" class="page flex-col justify-between">
        <div class="page-content overflow-y-auto">
             <!-- App screens will be injected here -->
        </div>
        <div class="w-full max-w-lg mx-auto p-2 flex-shrink-0">
             <div class="box-bg rounded-full flex justify-around items-center p-3 text-gray-400">
                <a href="#quests" class="nav-item text-center"><i class="fa-solid fa-shield-halved text-2xl"></i><span class="text-xs block">Quests</span></a>
                <a href="#inventory" class="nav-item text-center"><i class="fa-solid fa-box-archive text-2xl"></i><span class="text-xs block">Inventory</span></a>
                <a href="#profile" class="nav-item active text-center"><i class="fa-solid fa-user text-2xl"></i><span class="text-xs block">Profile</span></a>
                <a href="#collection" class="nav-item text-center"><i class="fa-solid fa-gem text-2xl"></i><span class="text-xs block">Collection</span></a>
                <a href="#journal" class="nav-item text-center"><i class="fa-solid fa-book-open text-2xl"></i><span class="text-xs block">Journal</span></a>
                <a href="#shop" class="nav-item text-center"><i class="fa-solid fa-store text-2xl"></i><span class="text-xs block">Shop</span></a>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE & CONFIG ---
            let state = { 
                currentPage: 'loading',
                currentAppScreen: 'profile',
                currentQuestTab: 'weekly',
                onboardingStep: 0, 
                player: null
            };
            const pages = { 
                loading: document.getElementById('page-loading'),
                intro: document.getElementById('page-intro'),
                login: document.getElementById('page-login'), 
                popup: document.getElementById('page-universal-popup'), 
                onboarding: document.getElementById('page-onboarding'), 
                app: document.getElementById('page-app') 
            };
            const appScreenContainer = pages.app.querySelector('.page-content');
            const popupBox = document.getElementById('popup-box');
            const appBody = document.getElementById('app-body');
            
            // --- TEMPLATES & GAME DATA ---
            const titles = {
                Assassin: { 1: 'Shadow Novice', 10: 'Silent Blade', 20: 'Phantom Edge', 30: 'Nightfall Striker' },
                Tank: { 1: 'Solid Guard', 10: 'Steel Bulwark', 20: 'Iron Colossus', 30: 'Unbreakable Aegis' },
                Mage: { 1: 'Mana Apprentice', 10: 'Skilled Conjurer', 20: 'Arcane Archmage', 30: 'Void Sovereign' }
            };

            const onboardingSteps = [
                { title: 'Create Your Profile', content: `<div><label for="name" class="block mb-1 text-sm">Name</label><input type="text" id="name" class="form-input w-full p-2 rounded-sm" placeholder="Player_01"></div><div class="grid grid-cols-2 gap-4 mt-4"><div><label for="age" class="block mb-1 text-sm">Age</label><input type="number" min="0" id="age" class="form-input w-full p-2 rounded-sm" placeholder="25"></div><div><label for="weight" class="block mb-1 text-sm">Weight (kg)</label><input type="number" min="0" id="weight" class="form-input w-full p-2 rounded-sm" placeholder="75"></div></div>` },
                { title: 'Choose Your Path', content: `<div class="space-y-3"><div class="class-card p-3 rounded-lg" data-class="Assassin"><h3 class="font-bold text-lg"><i class="fas fa-running mr-2"></i>Assassin</h3><p class="text-sm text-gray-400">Focus on agility and HIIT.</p></div><div class="class-card p-3 rounded-lg" data-class="Tank"><h3 class="font-bold text-lg"><i class="fas fa-shield-alt mr-2"></i>Tank</h3><p class="text-sm text-gray-400">Focus on strength and endurance.</p></div><div class="class-card p-3 rounded-lg" data-class="Mage"><h3 class="font-bold text-lg"><i class="fas fa-brain mr-2"></i>Mage</h3><p class="text-sm text-gray-400">Focus on flexibility and skill.</p></div></div>` },
                { 
                    title: 'Assess Your Power', 
                    content: `<p class="text-center text-sm text-gray-400 -mt-2 mb-4">Enter your max reps or time in a single set.</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block mb-1 text-sm">Push-ups</label><input type="number" min="0" id="pushups" class="form-input w-full p-2 rounded-sm" placeholder="15"></div>
                        <div><label class="block mb-1 text-sm">Sit-ups</label><input type="number" min="0" id="situps" class="form-input w-full p-2 rounded-sm" placeholder="25"></div>
                        <div><label class="block mb-1 text-sm">Squats</label><input type="number" min="0" id="squats" class="form-input w-full p-2 rounded-sm" placeholder="30"></div>
                        <div><label class="block mb-1 text-sm">Pull-ups</label><input type="number" min="0" id="pullups" class="form-input w-full p-2 rounded-sm" placeholder="5"></div>
                        <div><label class="block mb-1 text-sm">Leg Raises</label><input type="number" min="0" id="leg_raises" class="form-input w-full p-2 rounded-sm" placeholder="20"></div>
                        <div><label class="block mb-1 text-sm">Jumping Jacks</label><input type="number" min="0" id="jumping_jacks" class="form-input w-full p-2 rounded-sm" placeholder="50"></div>
                        <div><label class="block mb-1 text-sm">Plank (sec)</label><input type="number" min="0" id="plank" class="form-input w-full p-2 rounded-sm" placeholder="45"></div>
                        <div><label class="block mb-1 text-sm">Run (km)</label><input type="number" min="0" step="0.1" id="run" class="form-input w-full p-2 rounded-sm" placeholder="2.5"></div>
                    </div>` 
                }
            ];

             const shopItems = [
                { id: 'xp_boost', name: 'XP Boost', icon: 'fa-bolt-lightning', color: 'text-purple-400', desc: 'Doubles XP from your next quest reward.', price: 500 },
                { id: 'dungeon_key', name: 'Dungeon Key', icon: 'fa-key', color: 'text-yellow-400', desc: 'Unlocks a random special quest.', price: 1000 },
                { id: 'stamina_potion', name: 'Stamina Potion', icon: 'fa-bottle-droplet', color: 'text-green-400', desc: 'Instantly resets your Daily Quests for another round.', price: 2000 },
                { id: 'rune_of_fortune', name: 'Rune of Fortune', icon: 'fa-clover', color: 'text-yellow-400', desc: 'Guarantees your next Journal entry finds a Gift Box.', price: 1500 },
                { id: 'blacksmiths_anvil', name: 'Blacksmith\'s Anvil', icon: 'fa-anvil', color: 'text-orange-400', desc: 'A master tool that can permanently increase one stat by +1.', price: 10000 },
                { id: 'gift_box', name: 'Gift Box', icon: 'fa-gift', color: 'text-red-400', desc: 'Contains a mysterious reward. What will you get?', price: 2500 }
            ];

            const collectibles = [
                { id: 'shadow_monarch_helm', name: 'Helm of the Shadow Monarch', icon: 'fa-user-secret', rarity: 'legendary', desc: 'A helm imbued with the essence of the deepest shadows.' },
                { id: 'beast_monarch_fang', name: 'Fang of the Beast Monarch', icon: 'fa-paw', rarity: 'legendary', desc: 'A razor-sharp fang from a creature that ruled the wildlands.' },
                { id: 'iron_monarch_shield', name: 'Shield of the Iron Monarch', icon: 'fa-shield-halved', rarity: 'legendary', desc: 'An unbreakable shield that has withstood a thousand battles.' },
                { id: 'ice_giants_tear', name: 'Tear of the Ice Giant', icon: 'fa-snowflake', rarity: 'rare', desc: 'A crystal formed from the sorrow of a fallen frost giant.' },
                { id: 'phoenix_feather', name: 'Phoenix Feather', icon: 'fa-fire', rarity: 'rare', desc: 'A feather that burns with an eternal, comforting flame.' },
                { id: 'wyverns_scale', name: 'Wyvern\'s Scale', icon: 'fa-dragon', rarity: 'rare', desc: 'A shimmering scale that is harder than steel.' },
                { id: 'goblin_chiefs_ear', name: 'Goblin Chief\'s Ear', icon: 'fa-hat-wizard', rarity: 'common', desc: 'A grotesque, but surprisingly valuable, trophy.' },
                { id: 'lichs_phylactery', name: 'Lich\'s Phylactery', icon: 'fa-skull', rarity: 'common', desc: 'A small, cracked soul cage, now inert.' },
                { id: 'mana_crystal', name: 'Mana Crystal Shard', icon: 'fa-diamond', rarity: 'common', desc: 'A fragment of a crystal that hums with faint magical energy.' }
            ];
            
            // --- FUNCTIONS ---
            function createNewPlayerState() {
                return { 
                    name: 'Player_01', level: 1, xp: 0, gold: 100000, statPoints: 0,
                    xpForNextLevel: 100,
                    class: 'None', 
                    theme: 'default',
                    stats: { str: 10, agi: 10, sta: 10, int: 10, per: 10 },
                    baseline: { pushups: 15, situps: 25, squats: 30, pullups: 5, leg_raises: 20, jumping_jacks: 50, plank: 45, run: 2.5 },
                    streaks: { pushups: 0, situps: 0, squats: 0, pullups: 0, leg_raises: 0, jumping_jacks: 0, plank: 0, run: 0 },
                    inventory: {},
                    collectibles: [],
                    activeEffects: { xpBoost: false, runeOfFortune: false },
                    journalSubmittedToday: false,
                    dailyQuestsClaimedToday: false,
                    mainQuestsClaimed: { level5: false },
                    activeDungeonQuest: null,
                    hasCompletedTutorial: false
                };
            }

            function getPlayerTitle(player) {
                const classTitles = titles[player.class];
                if (!classTitles) return player.class;
                
                let currentTitle = classTitles[1];
                for (const levelReq in classTitles) {
                    if (player.level >= parseInt(levelReq)) {
                        currentTitle = classTitles[levelReq];
                    }
                }
                return currentTitle;
            }
            
            function applyTheme() {
                if(state.player.theme === 'monarch') {
                    appBody.classList.add('theme-monarch');
                } else {
                    appBody.classList.remove('theme-monarch');
                }
            }

            function switchPage(pageName) {
                state.currentPage = pageName;
                Object.keys(pages).forEach(key => {
                    const page = pages[key];
                    if (key === pageName) {
                        page.classList.add('active');
                    } else {
                        page.classList.remove('active');
                    }
                });
            }
            
            function showModal(content, onConfirm) {
                document.getElementById('universal-popup-content').innerHTML = content;
                switchPage('popup');

                const confirmButton = document.getElementById('popup-confirm');
                if (confirmButton && onConfirm) {
                    confirmButton.onclick = () => {
                        switchPage('app');
                        onConfirm();
                    };
                }

                const closeButton = document.getElementById('popup-close');
                if (closeButton) {
                    closeButton.onclick = () => switchPage('app');
                }
            }

            function showAutoPopup(content, duration = 2000) {
                return new Promise(resolve => {
                    document.getElementById('universal-popup-content').innerHTML = content;
                    switchPage('popup');
                    
                    setTimeout(() => {
                        popupBox.style.opacity = '0';
                        popupBox.style.transform = 'translateY(-20px)';
                        setTimeout(() => {
                            popupBox.style.opacity = '1';
                            popupBox.style.transform = 'translateY(0)';
                            resolve();
                        }, 500);
                    }, duration);
                });
            }

             async function showPopup(content) {
                return new Promise(resolve => {
                    document.getElementById('universal-popup-content').innerHTML = content;
                    switchPage('popup');
                    
                    const okButton = document.getElementById('popup-ok');
                    if (okButton) {
                        okButton.onclick = () => {
                            const prevPage = state.currentPage;
                            popupBox.style.opacity = '0';
                            popupBox.style.transform = 'translateY(-20px)';
                            setTimeout(() => {
                                if(prevPage === 'popup') {
                                    const activePages = Object.keys(pages).filter(p => pages[p].classList.contains('active') && p !== 'popup');
                                    if (activePages.length > 0) {
                                        switchPage(activePages[0]);
                                    } else {
                                        switchPage('login'); // Fallback
                                    }
                                }
                                popupBox.style.opacity = '1';
                                popupBox.style.transform = 'translateY(0)';
                                resolve();
                            }, 500);
                        };
                    }
                });
            }
            
            function renderAppScreen() {
                const contentContainer = appScreenContainer;
                contentContainer.classList.add('fade-out');

                setTimeout(() => {
                    let content = '';
                    if (state.currentAppScreen === 'profile') content = getProfileHTML();
                    if (state.currentAppScreen === 'shop') content = getShopHTML();
                    if (state.currentAppScreen === 'inventory') content = getInventoryHTML();
                    if (state.currentAppScreen === 'quests') content = getQuestsHTML();
                    if (state.currentAppScreen === 'journal') content = getJournalHTML();
                    if (state.currentAppScreen === 'collection') content = getCollectionHTML();
                    contentContainer.innerHTML = content;
                    
                    if (state.currentAppScreen === 'profile') {
                        updateDashboardUI();
                    } else if (state.currentAppScreen === 'shop') {
                        updateShopUI();
                    } else if (state.currentAppScreen === 'inventory') {
                        updateInventoryUI();
                    } else if (state.currentAppScreen === 'quests') {
                        updateQuestsUI();
                    } else if (state.currentAppScreen === 'journal') {
                        updateJournalUI();
                    } else if (state.currentAppScreen === 'collection') {
                        updateCollectionUI();
                    }
                    contentContainer.classList.remove('fade-out');
                }, 300);
            }
            
            function getProfileHTML() {
                return `<div class="w-full max-w-lg mx-auto space-y-6">
                    <div id="tutorial-profile-status" class="status-header">STATUS</div>
                    
                    <div id="tutorial-profile-main" class="box-bg p-4 rounded-lg">
                        <div class="flex items-center space-x-4">
                            <div class="text-7xl font-bold font-orbitron text-glow-subtle" id="level-text"></div>
                            <div class="flex-grow">
                                <h2 id="player-name" class="text-xl font-bold text-white"></h2>
                                <p class="text-gray-400">TITLE: <span id="player-title" class="text-blue-400 text-glow-blue"></span></p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="flex justify-between items-center text-sm mb-1">
                                <span class="font-semibold flex items-center">
                                    XP
                                    <i id="xp-boost-indicator" class="fas fa-bolt-lightning text-purple-400 ml-2 hidden"></i>
                                </span>
                                <span id="xp-text" class="text-gray-400"></span>
                            </div>
                            <div class="w-full progress-bar-bg rounded-full h-2.5"><div id="xp-bar" class="progress-bar-fill h-2.5 rounded-full"></div></div>
                        </div>
                    </div>

                    <div id="tutorial-profile-stats" class="box-bg p-4 rounded-lg">
                        <div class="stat-grid">
                            <div class="stat-item"><div class="stat-name"><i class="fa-solid fa-dumbbell"></i> STR: <span id="stat-str" class="ml-2 font-bold"></span></div><button data-stat="str" class="btn-plus w-7 h-7 rounded-md text-white"><i class="fa-solid fa-plus"></i></button></div>
                            <div class="stat-item"><div class="stat-name"><i class="fa-solid fa-heart-pulse"></i> STA: <span id="stat-sta" class="ml-2 font-bold"></span></div><button data-stat="sta" class="btn-plus w-7 h-7 rounded-md text-white"><i class="fa-solid fa-plus"></i></button></div>
                            <div class="stat-item"><div class="stat-name"><i class="fa-solid fa-person-running"></i> AGI: <span id="stat-agi" class="ml-2 font-bold"></span></div><button data-stat="agi" class="btn-plus w-7 h-7 rounded-md text-white"><i class="fa-solid fa-plus"></i></button></div>
                            <div class="stat-item"><div class="stat-name"><i class="fa-solid fa-brain"></i> INT: <span id="stat-int" class="ml-2 font-bold"></span></div><button data-stat="int" class="btn-plus w-7 h-7 rounded-md text-white"><i class="fa-solid fa-plus"></i></button></div>
                            <div class="stat-item"><div class="stat-name"><i class="fa-solid fa-hand-fist"></i> PER: <span id="stat-per" class="ml-2 font-bold"></span></div><button data-stat="per" class="btn-plus w-7 h-7 rounded-md text-white"><i class="fa-solid fa-plus"></i></button></div>
                        </div>
                        <div id="stat-points-display" class="mt-4 text-center">
                            <p class="text-sm text-gray-400">
                                Available Ability Points 
                                <i id="stat-points-info" class="fas fa-circle-info info-icon"></i>
                            </p>
                            <p id="stat-points-value" class="text-3xl font-bold text-yellow-400"></p>
                        </div>
                    </div>

                    <!-- Daily Quests moved here -->
                    <div id="daily-quest-container" class="box-bg p-4 rounded-lg"></div>
                </div>`;
            }

            function getShopHTML() {
                const itemsHTML = shopItems
                    .map(item => `
                    <div class="item-card rounded-lg p-3 text-center flex flex-col box-bg">
                        <div class="text-5xl ${item.color} my-3"><i class="fas ${item.icon}"></i></div>
                        <h3 class="font-semibold text-white">${item.name}</h3>
                        <p class="text-xs text-gray-400 flex-grow">${item.desc}</p>
                        <button data-item-id="${item.id}" class="btn-purchase w-full font-bold py-2 mt-3 rounded-md">
                            <i class="fas fa-coins mr-1"></i> ${item.price}
                        </button>
                    </div>`).join('');

                return `<div class="w-full max-w-lg mx-auto space-y-4">
                    <div class="box-bg p-4 rounded-lg text-center"><h1 class="text-2xl font-bold text-glow-purple">SHOP</h1></div>
                    <div id="tutorial-shop-balance" class="box-bg p-3 rounded-lg flex justify-between items-center">
                        <span class="font-semibold text-lg">Your Balance:</span>
                        <span id="gold-balance" class="font-bold text-2xl text-yellow-400"></span>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">${itemsHTML}</div>
                </div>`;
            }

            function getInventoryHTML() {
                let itemsHTML = '';
                const playerItems = Object.keys(state.player.inventory);

                if (playerItems.length === 0) {
                    itemsHTML = `<p class="text-center text-gray-400 col-span-full">Your inventory is empty.</p>`;
                } else {
                    itemsHTML = playerItems.map(itemId => {
                        const item = shopItems.find(i => i.id === itemId);
                        const quantity = state.player.inventory[itemId];
                        if (!item) return '';
                        
                        let buttons = '';
                        if (['dungeon_key', 'xp_boost', 'stamina_potion', 'rune_of_fortune', 'blacksmiths_anvil', 'gift_box'].includes(item.id)) {
                             buttons = `<button data-item-id="${item.id}" class="btn-use w-full font-bold py-2 mt-3 rounded-md">USE</button>`;
                        } else {
                            buttons = `<div class="py-2 mt-3">Cannot be sold</div>`;
                        }

                        return `<div class="item-card rounded-lg p-3 text-center flex flex-col box-bg">
                            <div class="text-5xl ${item.color} my-3"><i class="fas ${item.icon}"></i></div>
                            <h3 class="font-semibold text-white">${item.name}</h3>
                            <p class="text-xs text-gray-400 flex-grow">Quantity: ${quantity}</p>
                            ${buttons}
                        </div>`;
                    }).join('');
                }

                return `<div class="w-full max-w-lg mx-auto space-y-4">
                    <div class="box-bg p-4 rounded-lg text-center"><h1 class="text-2xl font-bold text-glow-purple">INVENTORY</h1></div>
                     <div class="box-bg p-3 rounded-lg flex justify-between items-center">
                        <span class="font-semibold text-lg">Your Balance:</span>
                        <span id="gold-balance-inv" class="font-bold text-2xl text-yellow-400"></span>
                    </div>
                    <div id="tutorial-inventory" class="grid grid-cols-2 sm:grid-cols-3 gap-4">${itemsHTML}</div>
                </div>`;
            }

            function getQuestsHTML() {
                return `<div class="w-full max-w-lg mx-auto space-y-4">
                    <div class="box-bg p-4 rounded-lg text-center"><h1 class="text-2xl font-bold text-glow-purple">QUESTS</h1></div>
                    <div id="tutorial-quest-tabs" class="box-bg p-2 rounded-lg flex justify-around">
                        <button data-tab="weekly" class="quest-tab active flex-1 py-2 font-semibold">Weekly</button>
                        <button data-tab="main" class="quest-tab flex-1 py-2 font-semibold">Main</button>
                        <button data-tab="dungeon" class="quest-tab flex-1 py-2 font-semibold">Dungeon</button>
                    </div>
                    <div id="quest-list-detailed" class="space-y-3"></div>
                </div>`;
            }
            
            function getJournalHTML() {
                if (state.player.journalSubmittedToday) {
                    return `<div class="w-full max-w-lg mx-auto space-y-4">
                        <div class="box-bg p-4 rounded-lg text-center"><h1 class="text-2xl font-bold text-glow-purple">DAILY JOURNAL</h1></div>
                        <div class="box-bg p-6 rounded-lg text-center">
                            <p class="text-lg">You have already submitted your entry for today.</p>
                            <p class="text-gray-400 mt-2">Please come back tomorrow to write again.</p>
                        </div>
                    </div>`;
                }

                return `<div class="w-full max-w-lg mx-auto space-y-4">
                    <div class="box-bg p-4 rounded-lg text-center"><h1 class="text-2xl font-bold text-glow-purple">DAILY JOURNAL</h1></div>
                    <div id="tutorial-journal" class="box-bg p-4 rounded-lg">
                        <p class="text-sm text-gray-300 mb-3">Write about your day. Your thoughts, your struggles, your victories. The system rewards reflection.</p>
                        <textarea id="journal-entry" class="form-input w-full h-48 p-2 rounded-sm resize-none" placeholder="Begin writing here..."></textarea>
                        <div class="flex justify-between items-center mt-3">
                            <span id="word-count" class="text-sm text-gray-400">0 words</span>
                            <button id="submit-journal" class="btn-system font-bold py-2 px-6 rounded-md">Submit Entry</button>
                        </div>
                    </div>
                </div>`;
            }

            function getCollectionHTML() {
                 const itemsHTML = collectibles.map(item => {
                    const isUnlocked = state.player.collectibles.includes(item.id);
                    if (isUnlocked) {
                        return `<div class="collectible-card unlocked ${item.rarity}" data-collectible-id="${item.id}">
                            <div class="text-5xl my-3"><i class="fas ${item.icon}"></i></div>
                            <h3 class="font-semibold text-white text-sm">${item.name}</h3>
                        </div>`;
                    } else {
                        return `<div class="collectible-card" data-collectible-id="${item.id}">
                            <div class="text-5xl text-gray-600 my-3"><i class="fas fa-question"></i></div>
                        </div>`;
                    }
                 }).join('');

                 return `<div class="w-full max-w-lg mx-auto space-y-4">
                    <div class="box-bg p-4 rounded-lg text-center"><h1 class="text-2xl font-bold text-glow-purple">COLLECTION</h1></div>
                    <div id="tutorial-collection" class="collection-grid">${itemsHTML}</div>
                </div>`;
            }

            function updateDashboardUI() {
                const p = state.player;
                document.getElementById('player-name').textContent = p.name;
                document.getElementById('player-title').textContent = getPlayerTitle(p);
                document.getElementById('level-text').textContent = p.level;
                document.getElementById('xp-text').textContent = `${p.xp} / ${p.xpForNextLevel}`;
                document.getElementById('xp-bar').style.width = `${(p.xp / p.xpForNextLevel) * 100}%`;
                
                document.getElementById('xp-boost-indicator').classList.toggle('hidden', !p.activeEffects.xpBoost);

                Object.keys(p.stats).forEach(key => {
                    document.getElementById(`stat-${key}`).textContent = p.stats[key];
                });

                const statPointsDisplay = document.getElementById('stat-points-display');
                document.getElementById('stat-points-value').textContent = p.statPoints;
                
                document.getElementById('stat-points-info').onclick = showStatInfoPopup;

                document.querySelectorAll('.btn-plus').forEach(btn => {
                    btn.disabled = p.statPoints <= 0;
                    btn.classList.toggle('pulsate', p.statPoints > 0);
                    btn.onclick = handleStatIncrease;
                });
                
                renderDailyQuests();
            }

            function updateShopUI() {
                appScreenContainer.querySelector('#gold-balance').innerHTML = `<i class="fas fa-coins mr-2"></i>${state.player.gold} G`;
                appScreenContainer.querySelectorAll('.btn-purchase').forEach(btn => btn.onclick = handlePurchase);
            }
            
            function updateInventoryUI() {
                appScreenContainer.querySelector('#gold-balance-inv').innerHTML = `<i class="fas fa-coins mr-2"></i>${state.player.gold} G`;
                appScreenContainer.querySelectorAll('.btn-use').forEach(btn => btn.onclick = handleUseItem);
            }
            
            function updateQuestsUI() {
                const questList = document.getElementById('quest-list-detailed');
                questList.classList.add('fade-out');

                setTimeout(() => {
                    let content = '';
                    const isClaimed = state.player.mainQuestsClaimed.level5;

                    if (state.currentQuestTab === 'weekly') {
                         content = `<div class="quest-card rounded-lg p-4">
                            <h3 class="font-semibold text-lg text-white">Weekly Consistency</h3>
                            <p class="text-sm text-gray-400 mb-3">Complete Daily Quests 5 times this week.</p>
                            <div class="w-full progress-bar-bg rounded-full h-2.5"><div class="bg-blue-500 h-2.5 rounded-full" style="width: 40%"></div></div>
                            <div class="border-t border-gray-600 mt-3 pt-3 flex justify-between items-center">
                                <div class="text-sm"><span class="font-semibold text-yellow-400">Rewards: </span>1 Dungeon Key</div>
                                <button class="btn-claim font-bold py-1 px-4 rounded-md" disabled>Claim</button>
                            </div>
                        </div>`;
                    } else if (state.currentQuestTab === 'main') {
                         content = `<div class="quest-card ${isClaimed ? 'completed' : ''} rounded-lg p-4">
                            <h3 class="font-semibold text-lg ${isClaimed ? '' : 'text-white'}">The First Step</h3>
                            <p class="text-sm text-gray-400 mb-3">Reach Level 5.</p>
                            <div class="w-full progress-bar-bg rounded-full h-2.5"><div class="bg-blue-500 h-2.5 rounded-full" style="width: ${ (state.player.level / 5) * 100 }% "></div></div>
                            <div class="border-t border-gray-600 mt-3 pt-3 flex justify-between items-center">
                                <div class="text-sm"><span class="font-semibold text-yellow-400">Rewards: </span>500 XP, 250 G</div>
                                <button id="claim-level-5" class="btn-claim font-bold py-1 px-4 rounded-md" ${state.player.level < 5 || isClaimed ? 'disabled' : ''}>${isClaimed ? 'Claimed' : 'Claim'}</button>
                            </div>
                        </div>`;
                    } else if (state.currentQuestTab === 'dungeon') {
                        if (state.player.activeDungeonQuest) {
                            const quest = state.player.activeDungeonQuest;
                            content = `<div class="quest-card rounded-lg p-4 border-l-4 border-red-500">
                                <h3 class="font-semibold text-lg text-white">${quest.title}</h3>
                                <p class="text-sm text-gray-400 mb-3">${quest.desc}</p>
                                <div class="border-t border-gray-600 mt-3 pt-3 flex justify-between items-center">
                                    <div class="text-sm"><span class="font-semibold text-yellow-400">Rewards: </span>${quest.reward.xp} XP, ${quest.reward.gold} G</div>
                                    <div class="flex space-x-2">
                                        <button id="complete-dungeon-quest" class="btn-use font-bold py-1 px-4 rounded-md">Complete</button>
                                        <button id="abandon-dungeon-quest" class="btn-sell font-bold py-1 px-4 rounded-md">Abandon</button>
                                    </div>
                                </div>
                            </div>`;
                        } else {
                            content = `<div class="quest-card rounded-lg p-4 text-center">
                                <p>No active dungeon quest.</p>
                                <p class="text-sm text-gray-400 mt-1">Use a Dungeon Key from your inventory to start one.</p>
                            </div>`;
                        }
                    }

                    questList.innerHTML = content;
                    questList.classList.remove('fade-out');

                    const claimLevel5Btn = document.getElementById('claim-level-5');
                    if (claimLevel5Btn) {
                        claimLevel5Btn.onclick = async () => {
                            if (state.player.mainQuestsClaimed.level5) return;
                            state.player.mainQuestsClaimed.level5 = true;
                            await addXp(500);
                            state.player.gold += 250;
                            await showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Rewards Claimed</h2><p class="text-xl">You received 500 XP and 250 Gold.</p>`, 2000);
                            switchPage('app');
                            renderAppScreen();
                        };
                    }
                    
                    const completeDungeonBtn = document.getElementById('complete-dungeon-quest');
                    if(completeDungeonBtn) {
                        completeDungeonBtn.onclick = handleCompleteDungeonQuest;
                    }
                    
                    const abandonDungeonBtn = document.getElementById('abandon-dungeon-quest');
                    if(abandonDungeonBtn) {
                        abandonDungeonBtn.onclick = handleAbandonDungeonQuest;
                    }

                }, 300);

                appScreenContainer.querySelectorAll('.quest-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === state.currentQuestTab);
                    tab.onclick = (e) => {
                        state.currentQuestTab = e.currentTarget.dataset.tab;
                        updateQuestsUI();
                    };
                });
            }
            
            function updateJournalUI() {
                const textarea = document.getElementById('journal-entry');
                const wordCountEl = document.getElementById('word-count');
                const submitBtn = document.getElementById('submit-journal');

                if (textarea) {
                    textarea.addEventListener('input', () => {
                        const text = textarea.value.trim();
                        const words = text.split(/\s+/).filter(word => word.length > 0);
                        wordCountEl.textContent = `${words.length} words`;
                    });
                }
                if (submitBtn) {
                    submitBtn.onclick = handleJournalSubmit;
                }
            }

            function updateCollectionUI() {
                appScreenContainer.querySelectorAll('.collectible-card').forEach(card => {
                    card.onclick = (e) => {
                        const collectibleId = e.currentTarget.dataset.collectibleId;
                        const item = collectibles.find(c => c.id === collectibleId);
                        const isUnlocked = state.player.collectibles.includes(item.id);

                        let content = '';
                        if(isUnlocked) {
                            content = `<h2 class="font-garamond text-2xl text-glow-subtle mb-4">${item.name}</h2>
                                       <p class="text-xl mb-6">${item.desc}</p>
                                       <p class="text-sm ${item.rarity === 'legendary' ? 'text-yellow-400' : item.rarity === 'rare' ? 'text-blue-400' : 'text-gray-400'}">Rarity: ${item.rarity.toUpperCase()}</p>
                                       <button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg mt-6">OK</button>`;
                        } else {
                            content = `<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Unknown Item</h2>
                                       <p class="text-xl mb-6">This item has not been discovered yet. It can be found in Gift Boxes.</p>
                                       <button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg mt-6">OK</button>`;
                        }
                        showPopup(content).then(() => switchPage('app'));
                    }
                })
            }
            
            function renderDailyQuests() {
                 const container = document.getElementById('daily-quest-container');
                 if(!container) return;
                 
                 if (state.player.dailyQuestsClaimedToday) {
                    container.innerHTML = `
                        <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                             <h3 class="text-lg font-semibold text-glow-blue">Daily Quests</h3>
                             <div class="text-right">
                                <p class="text-xs text-gray-400">Time until reset</p>
                                <p id="countdown-timer" class="font-orbitron text-red-400 text-glow-red">00:00:00</p>
                            </div>
                        </div>
                        <div class="text-center py-4">
                            <p class="text-lg">Daily Quests Completed!</p>
                            <p class="text-gray-400">Come back tomorrow for new challenges.</p>
                        </div>
                    `;
                    startCountdown(); // Still need the timer
                    return;
                 }
                 
                 container.innerHTML = `
                    <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                        <h3 class="text-lg font-semibold text-glow-blue">Daily Quests</h3>
                        <div class="text-right">
                            <p class="text-xs text-gray-400">Time until reset</p>
                            <p id="countdown-timer" class="font-orbitron text-red-400 text-glow-red">00:00:00</p>
                        </div>
                    </div>
                    <div id="quest-list" class="space-y-3"></div>
                    <p class="text-yellow-400 text-sm mt-4 text-center"><i class="fas fa-exclamation-triangle mr-2"></i>Failure to complete will result in a penalty.</p>
                    <div id="claim-container" class="mt-4 hidden"><button id="claim-button" class="btn-claim w-full font-bold py-2 rounded-md">Claim Reward</button></div>
                 `;
                 generateQuests();
                 startCountdown();
            }

            function generateQuests() {
                const questList = document.getElementById('quest-list');
                if (!questList) return;
                
                const p = state.player;
                let dailyQuests = [];
                const allQuests = {
                    pushups: { name: 'Push-ups', unit: 'reps' },
                    situps: { name: 'Sit-ups', unit: 'reps' },
                    squats: { name: 'Squats', unit: 'reps' },
                    pullups: { name: 'Pull-ups', unit: 'reps' },
                    leg_raises: { name: 'Leg Raises', unit: 'reps' },
                    jumping_jacks: { name: 'Jumping Jacks', unit: 'reps' },
                    plank: { name: 'Plank', unit: 'seconds' },
                    run: { name: 'Run', unit: 'km' }
                };

                // Determine quests based on class
                switch (p.class) {
                    case 'Tank':
                        dailyQuests = ['pullups', 'pushups', 'squats'];
                        break;
                    case 'Assassin':
                        dailyQuests = ['run', 'jumping_jacks', 'leg_raises'];
                        break;
                    case 'Mage':
                        dailyQuests = ['plank', 'situps', 'squats'];
                        break;
                    default:
                        dailyQuests = ['pushups', 'situps', 'squats'];
                }

                let questHTML = '';
                dailyQuests.forEach(key => {
                    const questInfo = allQuests[key];
                    let goal = 0;
                    goal = Math.max(5, Math.ceil(p.baseline[key]) || 5);
                    if(key === 'run') goal = Math.max(1, p.baseline[key] || 1);
                    
                    questHTML += `<div class="flex items-center space-x-3 quest-item">
                        <input type="checkbox" class="quest-checkbox" data-quest-key="${key}">
                        <label class="flex-1">${questInfo.name} [ 0 / ${goal} ${questInfo.unit} ]</label>
                    </div>`;
                });

                questList.innerHTML = questHTML;
                
                questList.querySelectorAll('.quest-checkbox').forEach(cb => cb.addEventListener('change', checkQuestsCompletion));
                document.getElementById('claim-container').classList.add('hidden');
                document.getElementById('claim-button').disabled = true;
                document.getElementById('claim-button').onclick = handleClaim;
            }
            
            function checkQuestsCompletion() {
                const allChecked = [...document.querySelectorAll('#quest-list .quest-checkbox')].every(cb => cb.checked);
                if (allChecked) {
                    document.getElementById('claim-container').classList.remove('hidden');
                    document.getElementById('claim-button').disabled = false;
                }
            }

            async function addXp(amount) {
                state.player.xp += amount;
                let leveledUp = false;
                while (state.player.xp >= state.player.xpForNextLevel) {
                    leveledUp = true;
                    state.player.level++;
                    state.player.xp -= state.player.xpForNextLevel;
                    state.player.xpForNextLevel = Math.floor(state.player.xpForNextLevel * 1.2);
                    state.player.statPoints += 5;
                }
                
                if (state.player.level >= 85 && state.player.theme !== 'monarch') {
                    state.player.theme = 'monarch';
                    applyTheme();
                    await showPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">TITLE OF MONARCH</h2><p class="text-xl mb-6">You have reached the pinnacle of power. The Monarch theme is now yours.</p><button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg mt-6">OK</button>`);
                }

                if (leveledUp) {
                    const levelUpPopupContent = `<h2 class="font-garamond text-2xl text-glow-subtle mb-4">LEVEL UP!</h2><p class="text-xl mb-6">You have reached Level ${state.player.level}.</p><p>You have gained 5 Stat Points.</p><button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg mt-6">OK</button>`;
                    await showPopup(levelUpPopupContent);
                }
                
                if (state.currentAppScreen === 'profile') {
                    updateDashboardUI();
                }
            }

            let countdownInterval;
            function startCountdown() {
                const timerEl = document.getElementById('countdown-timer');
                if (!timerEl) return;
                if(countdownInterval) clearInterval(countdownInterval);

                countdownInterval = setInterval(() => {
                    const now = new Date();
                    const tomorrow = new Date();
                    tomorrow.setDate(now.getDate() + 1);
                    tomorrow.setHours(0, 0, 0, 0);

                    const timeRemaining = tomorrow - now;

                    if (timeRemaining <= 1000) {
                        state.player.journalSubmittedToday = false;
                        state.player.dailyQuestsClaimedToday = false;
                        document.querySelectorAll('#quest-list .quest-checkbox:not(:checked)').forEach(cb => {
                            const key = cb.dataset.questKey;
                            if(state.player.streaks[key]) state.player.streaks[key] = 0;
                        });
                        if (state.currentAppScreen === 'profile') {
                           renderDailyQuests();
                        }
                    }

                    const hours = Math.floor((timeRemaining / (1000 * 60 * 60)) % 24).toString().padStart(2, '0');
                    const minutes = Math.floor((timeRemaining / 1000 / 60) % 60).toString().padStart(2, '0');
                    const seconds = Math.floor((timeRemaining / 1000) % 60).toString().padStart(2, '0');
                    
                    if(timerEl) timerEl.textContent = `${hours}:${minutes}:${seconds}`;
                }, 1000);
            }

            // --- EVENT HANDLERS ---
            async function handleClaim() {
                let xpAmount = 150;
                let baselineIncreased = false;
                let baselineUpdateText = '';
                state.player.dailyQuestsClaimedToday = true;

                if(state.player.activeEffects.xpBoost) {
                    xpAmount *= 2;
                    state.player.activeEffects.xpBoost = false;
                }

                document.querySelectorAll('#quest-list .quest-checkbox').forEach(cb => {
                    const key = cb.dataset.questKey;
                    if (cb.checked) {
                        state.player.streaks[key]++;
                        if (state.player.streaks[key] >= 3) {
                            baselineIncreased = true;
                            if (key === 'run') {
                                state.player.baseline[key] += 0.1; 
                                state.player.baseline[key] = Math.round(state.player.baseline[key] * 10) / 10;
                            } else {
                                state.player.baseline[key]++;
                            }
                            baselineUpdateText += `<p>Your ${key} baseline has increased!</p>`;
                            state.player.streaks[key] = 0;
                        }
                    } else {
                        state.player.streaks[key] = 0;
                    }
                });

                state.player.gold += 100;
                let rewardText = `<p class="text-xl">You received ${xpAmount} XP and 100 Gold.</p>`;
                if (xpAmount > 150) {
                    rewardText += `<p class="text-purple-400 text-sm mt-2">XP Boost applied!</p>`;
                }
                await showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Rewards Claimed</h2>${rewardText}`, 2500);
                await addXp(xpAmount);
                
                if (baselineIncreased) {
                    await showPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Baseline Increased!</h2>${baselineUpdateText}<button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg mt-6">OK</button>`);
                }
                
                switchPage('app');
                updateDashboardUI();
            }
            
            async function handleJournalSubmit() {
                const textarea = document.getElementById('journal-entry');
                const text = textarea.value.trim();
                const words = text.split(/\s+/).filter(word => word.length > 0);
                const wordCount = words.length;

                if (wordCount === 0) {
                    await showPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Empty Entry</h2><p class="text-xl mb-6">Please write something before submitting.</p><button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg mt-6">OK</button>`);
                    switchPage('app');
                    return;
                }

                const xpGained = wordCount;
                const goldGained = Math.round(wordCount * 0.5);
                const gotGiftBox = Math.random() < 0.25 || state.player.activeEffects.runeOfFortune;

                if (state.player.activeEffects.runeOfFortune) {
                    state.player.activeEffects.runeOfFortune = false;
                }

                await addXp(xpGained);
                state.player.gold += goldGained;
                state.player.journalSubmittedToday = true;

                let rewardText = `<p class="text-xl">You received ${xpGained} XP and ${goldGained} Gold.</p>`;
                if (gotGiftBox) {
                    state.player.inventory['gift_box'] = (state.player.inventory['gift_box'] || 0) + 1;
                    rewardText += `<p class="text-xl mt-2 text-red-400">You also found a Gift Box!</p>`;
                }
                
                await showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Journal Submitted</h2>${rewardText}`, 3000);
                switchPage('app');
                renderAppScreen();
            }

            function handleStatIncrease(e) {
                const stat = e.currentTarget.dataset.stat;
                if (state.player.statPoints > 0) {
                    state.player.statPoints--;
                    state.player.stats[stat]++;
                    
                    const button = e.currentTarget;
                    button.classList.add('clicked');
                    setTimeout(() => button.classList.remove('clicked'), 300);

                    updateDashboardUI();
                }
            }
            
            async function showStatInfoPopup() {
                const content = `<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Ability Points</h2>
                                 <p class="text-left mb-2">These points allow you to permanently increase your base stats.</p>
                                 <ul class="text-left list-disc list-inside mb-4">
                                     <li><b>How to Use:</b> Click the '+' button next to a stat on your profile.</li>
                                     <li><b>How to Gain:</b> You gain 5 Ability Points every time you Level Up.</li>
                                 </ul>
                                 <button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg mt-6">OK</button>`;
                await showPopup(content);
                switchPage('app');
            }
            
            async function initializeApp() {
                state.player = createNewPlayerState();
                applyTheme();
                await showPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4"><i class="fas fa-exclamation-circle mr-2"></i>Alert</h2><p class="text-xl mb-8 font-semibold text-white">[ Welcome, player. ]</p><button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg">OK</button>`);
                switchPage('onboarding');
                renderOnboardingStep();
            }

            function renderOnboardingStep() {
                const step = onboardingSteps[state.onboardingStep];
                document.getElementById('onboarding-content').innerHTML = `<h2 class="font-garamond text-2xl text-glow-subtle mb-4 text-center">${step.title}</h2>${step.content}`;
                if (state.onboardingStep === 1) {
                    document.querySelectorAll('.class-card').forEach(card => card.addEventListener('click', handleClassSelection));
                }
                document.getElementById('next-button').textContent = state.onboardingStep === onboardingSteps.length - 1 ? 'Begin' : 'Next';
            }

            function validateOnboardingStep() {
                const step = state.onboardingStep;
                if (step === 0) {
                    const fields = ['name', 'age', 'weight'];
                    return fields.every(id => document.getElementById(id).value.trim() !== '');
                } else if (step === 1) {
                    return state.player.class !== 'None';
                } else if (step === 2) {
                    const fields = ['pushups', 'situps', 'squats', 'pullups', 'leg_raises', 'jumping_jacks', 'plank', 'run'];
                    return fields.every(id => document.getElementById(id).value.trim() !== '');
                }
                return true;
            }

            async function handleLoginAttempt() {
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value.trim();
                if (!email || !password) {
                    const errorPopupContent = `<h2 class="font-garamond text-2xl text-glow-subtle mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Incomplete</h2><p class="text-xl mb-6">Please enter both email and password.</p><button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg mt-6">OK</button>`;
                    await showPopup(errorPopupContent);
                    switchPage('login');
                } else {
                    initializeApp();
                }
            }

            async function handleSignupAttempt() {
                const email = document.getElementById('signup-email').value.trim();
                const password = document.getElementById('signup-password').value.trim();
                if (!email || !password) {
                    const errorPopupContent = `<h2 class="font-garamond text-2xl text-glow-subtle mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Incomplete</h2><p class="text-xl mb-6">Please enter both email and password.</p><button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg mt-6">OK</button>`;
                    await showPopup(errorPopupContent);
                    switchPage('login');
                    document.getElementById('login-form').classList.add('hidden');
                    document.getElementById('signup-form').classList.remove('hidden');
                } else {
                    initializeApp();
                }
            }
            
            async function handleUseItem(e) {
                const itemId = e.currentTarget.dataset.itemId;
                let requiresRerender = true;

                if (itemId === 'dungeon_key') {
                    // ... (existing code)
                } else if (itemId === 'xp_boost') {
                    // ... (existing code)
                } else if (itemId === 'stamina_potion') {
                    state.player.inventory.stamina_potion--;
                    if (state.player.inventory.stamina_potion <= 0) delete state.player.inventory.stamina_potion;
                    state.player.dailyQuestsClaimedToday = false;
                    await showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Stamina Restored!</h2><p class="text-xl">Your Daily Quests have been reset.</p>`, 2000);
                } else if (itemId === 'rune_of_fortune') {
                     if(state.player.activeEffects.runeOfFortune) {
                        await showPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Already Active</h2><p class="text-xl mb-6">A Rune of Fortune is already active.</p><button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg mt-6">OK</button>`);
                        requiresRerender = false;
                    } else {
                        state.player.inventory.rune_of_fortune--;
                        if (state.player.inventory.rune_of_fortune <= 0) delete state.player.inventory.rune_of_fortune;
                        state.player.activeEffects.runeOfFortune = true;
                        await showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Fortune Smiles!</h2><p class="text-xl">Your next journal entry is guaranteed to find a Gift Box.</p>`, 2500);
                    }
                } else if (itemId === 'blacksmiths_anvil') {
                    handleUseAnvil();
                    requiresRerender = false;
                } else if (itemId === 'gift_box') {
                    handleOpenGiftBox();
                    requiresRerender = false;
                }
                
                if (requiresRerender) {
                    switchPage('app');
                    renderAppScreen();
                }
            }

            async function handleUseAnvil() {
                let content = `<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Blacksmith's Anvil</h2>
                               <p class="text-xl mb-6">Choose a stat to permanently increase by +1.</p>
                               <div class="grid grid-cols-2 gap-2">`;
                Object.keys(state.player.stats).forEach(stat => {
                    content += `<button class="btn-system font-bold p-2 anvil-choice" data-stat="${stat}">${stat.toUpperCase()}</button>`
                });
                content += `</div><button id="popup-close" class="btn-system w-full font-bold py-2 mt-4 rounded-sm">Cancel</button>`;
                
                showModal(content);
                document.querySelectorAll('.anvil-choice').forEach(button => {
                    button.onclick = async (e) => {
                        const statToUpgrade = e.currentTarget.dataset.stat;
                        state.player.stats[statToUpgrade]++;
                        state.player.inventory.blacksmiths_anvil--;
                        if (state.player.inventory.blacksmiths_anvil <= 0) {
                            delete state.player.inventory.blacksmiths_anvil;
                        }
                        await showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Stat Increased!</h2><p class="text-xl">${statToUpgrade.toUpperCase()} has permanently increased by 1.</p>`, 2500);
                        switchPage('app');
                        renderAppScreen();
                    }
                });
            }

            function generateGiftBoxRewards() {
                const rewards = [];
                const rewardPool = [
                    { type: 'gold', value: 1000, chance: 0.4 },
                    { type: 'xp', value: 500, chance: 0.3 },
                    { type: 'dungeon_key', chance: 0.15 },
                    { type: 'stat_point', value: 2, chance: 0.1 },
                    { type: 'collectible', chance: 0.05 }
                ];
                
                while(rewards.length < 3) {
                    const rand = Math.random();
                    let cumulativeChance = 0;
                    for(const reward of rewardPool) {
                        cumulativeChance += reward.chance;
                        if(rand < cumulativeChance) {
                            rewards.push(reward);
                            break;
                        }
                    }
                }
                return rewards;
            }

            async function handleOpenGiftBox() {
                state.player.inventory.gift_box--;
                if (state.player.inventory.gift_box <= 0) {
                    delete state.player.inventory.gift_box;
                }
                const rewards = generateGiftBoxRewards();
                let content = `<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Choose a Reward</h2>
                               <p class="text-gray-400 mb-6">Click a card to reveal your prize!</p>
                               <div class="reward-card-container">`;
                
                rewards.forEach((reward, index) => {
                     content += `<div class="reward-card" data-reward-index="${index}">
                                    <div class="reward-card-inner">
                                        <div class="reward-card-front"><i class="fas fa-question text-5xl"></i></div>
                                        <div class="reward-card-back"></div>
                                    </div>
                                </div>`;
                });
                content += `</div>`;
                
                showModal(content);

                document.querySelectorAll('.reward-card').forEach(card => {
                    card.onclick = async (e) => {
                        if(e.currentTarget.classList.contains('flipped')) return;

                        const chosenIndex = parseInt(e.currentTarget.dataset.rewardIndex);
                        const chosenReward = rewards[chosenIndex];
                        let popupText = '';

                        // Apply reward
                        if (chosenReward.type === 'gold') {
                            state.player.gold += chosenReward.value;
                            popupText = `You found ${chosenReward.value} Gold!`;
                        } else if (chosenReward.type === 'xp') {
                            await addXp(chosenReward.value);
                            popupText = `You gained ${chosenReward.value} XP!`;
                        } else if (chosenReward.type === 'dungeon_key') {
                            state.player.inventory.dungeon_key = (state.player.inventory.dungeon_key || 0) + 1;
                            popupText = `You found a Dungeon Key!`;
                        } else if (chosenReward.type === 'stat_point') {
                             state.player.statPoints += chosenReward.value;
                             popupText = `You gained ${chosenReward.value} Ability Points!`;
                        } else if (chosenReward.type === 'collectible') {
                            const unowned = collectibles.filter(c => !state.player.collectibles.includes(c.id));
                            const foundCollectible = unowned.length > 0 ? unowned[Math.floor(Math.random() * unowned.length)] : collectibles[Math.floor(Math.random() * collectibles.length)];
                            if (!state.player.collectibles.includes(foundCollectible.id)) {
                                state.player.collectibles.push(foundCollectible.id);
                            }
                            popupText = `You found a collectible: ${foundCollectible.name}!`;
                        }
                        
                        // Flip all cards
                        document.querySelectorAll('.reward-card').forEach((c, i) => {
                            c.classList.add('flipped');
                            const back = c.querySelector('.reward-card-back');
                            const reward = rewards[i];
                            if(reward.type === 'gold') back.innerHTML = `<i class="fas fa-coins text-3xl text-yellow-400"></i><span class="mt-2 text-sm">${reward.value} G</span>`;
                            else if (reward.type === 'xp') back.innerHTML = `<i class="fas fa-star text-3xl text-blue-400"></i><span class="mt-2 text-sm">${reward.value} XP</span>`;
                            else if (reward.type === 'dungeon_key') back.innerHTML = `<i class="fas fa-key text-3xl text-yellow-500"></i><span class="mt-2 text-sm">Dungeon Key</span>`;
                            else if (reward.type === 'stat_point') back.innerHTML = `<i class="fas fa-plus text-3xl text-green-400"></i><span class="mt-2 text-sm">${reward.value} Points</span>`;
                            else if (reward.type === 'collectible') back.innerHTML = `<i class="fas fa-gem text-3xl text-purple-400"></i><span class="mt-2 text-sm">Collectible</span>`;
                        });
                        
                        setTimeout(async () => {
                            await showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Reward Claimed!</h2><p>${popupText}</p>`, 2500);
                            switchPage('app');
                            renderAppScreen();
                        }, 2000);
                    }
                });

            }

            async function handleCompleteDungeonQuest() {
                const quest = state.player.activeDungeonQuest;
                if (!quest) return;

                let xpAmount = quest.reward.xp;
                 if(state.player.activeEffects.xpBoost) {
                    xpAmount *= 2;
                    state.player.activeEffects.xpBoost = false;
                }

                await addXp(xpAmount);
                state.player.gold += quest.reward.gold;
                state.player.activeDungeonQuest = null;

                let rewardText = `<p>You received ${xpAmount} XP and ${quest.reward.gold} Gold.</p>`;
                if (xpAmount > quest.reward.xp) {
                     rewardText += `<p class="text-purple-400 text-sm mt-2">XP Boost applied!</p>`;
                }
                await showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Dungeon Cleared!</h2>${rewardText}`, 2500);
                switchPage('app');
                renderAppScreen();
            }
            
            async function handleAbandonDungeonQuest() {
                 const onConfirm = () => {
                    state.player.activeDungeonQuest = null;
                    showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Quest Abandoned</h2>`, 1500).then(() => {
                        switchPage('app');
                        renderAppScreen();
                    });
                };
                showModal(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Abandon Quest?</h2><p class="text-xl mb-6">Are you sure you want to abandon this quest? You will not be refunded the key.</p><div class="flex justify-center space-x-4"><button id="popup-close" class="btn-system font-bold py-2 px-8 rounded-sm">Cancel</button><button id="popup-confirm" class="btn-sell font-bold py-2 px-8 rounded-sm">Confirm</button></div>`, onConfirm);
            }

            function generateDungeonQuest() {
                const p = state.player;
                const exercises = ['pushups', 'situps', 'squats', 'run'];
                const chosenExercise = exercises[Math.floor(Math.random() * exercises.length)];
                
                const multiplier = 1.5 + (p.level * 0.1);
                const baseValue = p.baseline[chosenExercise] || 1;
                
                let goal, title, desc, reward;

                if (chosenExercise === 'run') {
                    goal = Math.round((baseValue * multiplier) * 10) / 10;
                    title = "The Endless Road";
                    desc = `Endure and run ${goal}km in a single session.`;
                    reward = { xp: Math.round(goal * 500), gold: Math.round(goal * 250) };
                } else {
                    goal = Math.ceil((baseValue * multiplier) / 5) * 5;
                    const exerciseName = chosenExercise.charAt(0).toUpperCase() + chosenExercise.slice(1);
                    title = `Test of ${exerciseName}`;
                    desc = `Prove your might. Complete ${goal} ${exerciseName}.`;
                    reward = { xp: Math.round(goal * 15), gold: Math.round(goal * 8) };
                }

                return { id: `dq_${Date.now()}`, title, desc, reward };
            }

            document.addEventListener('input', (e) => {
                if (e.target.type === 'number' && e.target.value < 0) {
                    e.target.value = 0;
                }
            });

            document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-form').classList.add('hidden'); document.getElementById('signup-form').classList.remove('hidden'); });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('signup-form').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden'); });

            document.getElementById('login-button').addEventListener('click', handleLoginAttempt);
            document.getElementById('signup-button').addEventListener('click', handleSignupAttempt);
            
            document.getElementById('next-button').addEventListener('click', async () => {
                if (!validateOnboardingStep()) {
                    const errorPopupContent = `<h2 class="font-garamond text-2xl text-glow-subtle mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Incomplete</h2><p class="text-xl mb-6">Please complete all fields to proceed.</p><button id="popup-ok" class="btn-system font-bold py-2 px-12 rounded-sm text-lg mt-6">OK</button>`;
                    await showPopup(errorPopupContent);
                    switchPage('onboarding'); 
                    return;
                }

                if (state.onboardingStep === 0) {
                    state.player.name = document.getElementById('name').value.trim();
                } else if (state.onboardingStep === 2) {
                    Object.keys(state.player.baseline).forEach(key => {
                        const input = document.getElementById(key);
                        if(input) {
                            state.player.baseline[key] = parseFloat(input.value) || 0;
                        }
                    });

                    await showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4"><i class="fas fa-scroll mr-2"></i>Notice</h2><p class="text-xl mb-8 font-semibold text-white">[ A Daily Quest has arrived. ]</p>`, 2500);
                    switchPage('app');
                    renderAppScreen();
                    
                    if (!state.player.hasCompletedTutorial) {
                        setTimeout(startTutorial, 500);
                    }
                } 
                
                if (state.onboardingStep < 2) {
                    state.onboardingStep++;
                    renderOnboardingStep();
                }
            });

            function handleClassSelection(e) {
                document.querySelectorAll('.class-card').forEach(c => c.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                state.player.class = e.currentTarget.dataset.class;
            }

            function handlePurchase(e) {
                const itemId = e.currentTarget.dataset.itemId;
                const item = shopItems.find(i => i.id === itemId);
                if (!item) return;

                const onConfirm = () => {
                    if (state.player.gold >= item.price) {
                        state.player.gold -= item.price;
                        state.player.inventory[item.id] = (state.player.inventory[item.id] || 0) + 1;
                        showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Purchase Successful</h2><p class="text-xl">You bought ${item.name}.</p>`, 2000).then(() => { switchPage('app'); renderAppScreen(); });
                    } else {
                        showAutoPopup(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Insufficient Funds</h2><p class="text-xl">You don't have enough Gold.</p>`, 2000).then(() => switchPage('app'));
                    }
                };
                
                showModal(`<h2 class="font-garamond text-2xl text-glow-subtle mb-4">Confirm Purchase</h2><p class="text-xl mb-6">Buy ${item.name} for ${item.price} G?</p><div class="flex justify-center space-x-4"><button id="popup-close" class="btn-system font-bold py-2 px-8 rounded-sm">Cancel</button><button id="popup-confirm" class="btn-purchase font-bold py-2 px-8 rounded-sm">Confirm</button></div>`, onConfirm);
            }
            
            pages.app.querySelectorAll('.nav-item').forEach(nav => {
                nav.addEventListener('click', (e) => {
                    e.preventDefault();
                    pages.app.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    const newScreen = e.currentTarget.hash.substring(1);
                    if (newScreen !== state.currentAppScreen) {
                        state.currentAppScreen = newScreen;
                        renderAppScreen();
                    }
                });
            });

            // --- Initial Loading Logic ---
            setTimeout(() => {
                switchPage('intro');
            }, 3000);

            document.getElementById('accept-button').addEventListener('click', () => {
                switchPage('login');
            });

            // --- TUTORIAL LOGIC ---
            const tutorialOverlay = document.getElementById('tutorial-overlay');
            const tutorialBox = document.getElementById('tutorial-box');
            const tutorialText = document.getElementById('tutorial-text');
            const tutorialNextBtn = document.getElementById('tutorial-next');
            let tutorialStep = 0;
            let highlightedElement = null;

            const tutorialSteps = [
                { text: "System Initializing... Welcome, Player. Let's begin your orientation." },
                { element: '#tutorial-profile-main', text: "This is your Status screen. Track your Level, XP, and evolving Title here. This is the core of your progression." },
                { element: '#tutorial-profile-stats', text: "These are your core stats. As you level up, you'll earn Ability Points to increase them and grow stronger." },
                { element: '#daily-quest-container', text: "Your Daily Quests are your primary mission. Complete them every day to earn XP and Gold. Consistency is key to improving your baseline." },
                { action: () => navigateToAppScreen('quests'), element: '#tutorial-quest-tabs', text: "The Quests tab contains your long-term goals. Check here for Weekly, Main, and high-risk Dungeon quests." },
                { action: () => navigateToAppScreen('inventory'), element: '#tutorial-inventory', text: "Your Inventory stores all the items you earn and purchase, like Dungeon Keys for special quests." },
                { action: () => navigateToAppScreen('shop'), element: '#tutorial-shop-balance', text: "Use Gold earned from quests in the Shop to buy powerful items and boosts." },
                { action: () => navigateToAppScreen('journal'), element: '#tutorial-journal', text: "Finally, the Journal rewards reflection. Write about your day to earn extra XP and Gold, and maybe even find a surprise." },
                { action: () => navigateToAppScreen('collection'), element: '#tutorial-collection', text: "This is your Collection, a hall for the rare trophies and artifacts you find. Discover them all to prove your legacy." },
                { action: () => navigateToAppScreen('profile'), text: "Your orientation is complete. The system is yours. Begin your ascent." }
            ];

            function navigateToAppScreen(screen) {
                document.querySelector(`.nav-item[href="#${screen}"]`).click();
            }

            function startTutorial() {
                tutorialStep = 0;
                tutorialOverlay.classList.add('active');
                showTutorialStep();
            }

            function showTutorialStep() {
                if (highlightedElement) {
                    highlightedElement.classList.remove('tutorial-highlight');
                    highlightedElement = null;
                }

                if (tutorialStep >= tutorialSteps.length) {
                    endTutorial();
                    return;
                }

                const step = tutorialSteps[tutorialStep];
                
                const performStep = () => {
                    tutorialText.textContent = step.text;
                    
                    if (step.element) {
                        highlightedElement = document.querySelector(step.element);
                        if (highlightedElement) {
                            highlightedElement.classList.add('tutorial-highlight');
                            const rect = highlightedElement.getBoundingClientRect();
                            
                            tutorialBox.style.top = `${rect.bottom + 15}px`;
                            tutorialBox.style.left = `50%`;
                            tutorialBox.style.transform = `translateX(-50%)`;

                            const boxRect = tutorialBox.getBoundingClientRect();
                            if (boxRect.bottom > window.innerHeight - 20) {
                                tutorialBox.style.top = `${rect.top - boxRect.height - 15}px`;
                            }

                            const finalBoxRect = tutorialBox.getBoundingClientRect();
                            if (finalBoxRect.left < 10) {
                                tutorialBox.style.left = '10px';
                                tutorialBox.style.transform = 'translateX(0)';
                            }
                             if (finalBoxRect.right > window.innerWidth - 10) {
                                tutorialBox.style.left = `${window.innerWidth - 10}px`;
                                tutorialBox.style.transform = 'translateX(-100%)';
                            }
                        }
                    } else {
                        tutorialBox.style.top = `50%`;
                        tutorialBox.style.left = `50%`;
                        tutorialBox.style.transform = `translate(-50%, -50%)`;
                    }
                    
                    if(tutorialStep === tutorialSteps.length -1) {
                         tutorialNextBtn.textContent = 'Begin';
                    }
                }

                if (step.action) {
                    step.action();
                    setTimeout(performStep, 400);
                } else {
                    performStep();
                }
            }

            function endTutorial() {
                tutorialOverlay.classList.remove('active');
                if (highlightedElement) {
                    highlightedElement.classList.remove('tutorial-highlight');
                }
                state.player.hasCompletedTutorial = true;
            }

            tutorialNextBtn.addEventListener('click', () => {
                tutorialStep++;
                showTutorialStep();
            });

        });
    </script>
</body>
</html>


